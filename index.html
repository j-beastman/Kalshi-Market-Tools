<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalshi Market Tools - Hedge Anything</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 17 + ReactDOM 17 -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.production.min.js?v=4"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.production.min.js?v=4"></script>

  <!-- PropTypes must come before Recharts -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js?v=4"></script>
  <!-- Recharts (UMD) -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/recharts@2.9.0/umd/Recharts.min.js?v=4"></script>

  <!-- Babel for JSX (dev) -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.7/babel.min.js?v=4"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
    .market-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .skeleton { background: linear-gradient(90deg, #111827 25%, #1f2937 50%, #111827 75%); background-size: 1000px 100%; animation: loading 2s infinite; }
    @keyframes loading { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
    .hedge-card { transition: all 0.3s ease; }
    .hedge-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .allocation-slider { transition: all 0.2s ease; }
    .allocation-slider:hover { transform: scale(1.02); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root">Loading...</div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const RechartsLib = window.Recharts || {};
    const { LineChart, Line, BarChart, Bar, ComposedChart, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell, PieChart, Pie } = RechartsLib;

    // --- CONFIG ---
    const params = new URLSearchParams(location.search);
    const API_BASE = params.get('api') || "https://kalshi-market-tools-production.up.railway.app";

    // --- UTIL ---
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const fallback = (v, d) => (v === undefined || v === null ? d : v);

    // --- SIMPLE FALLBACK CHART ---
    const SimpleChart = ({ data, title }) => {
      if (!data || data.length === 0) return null;
      const maxValue = Math.max(...data.map(d => d.value || 0), 1);
      return (
        <div className="bg-white rounded-lg shadow p-4">
          <h4 className="text-sm font-semibold mb-3">{title}</h4>
          <div className="space-y-2">
            {data.slice(0, 10).map((item, i) => (
              <div key={i} className="flex items-center">
                <span className="text-xs w-16">{item.label}</span>
                <div className="flex-1 mx-2">
                  <div className="h-4 bg-blue-500 rounded" style={{ width: `${(item.value / maxValue) * 100}%` }}></div>
                </div>
                <span className="text-xs">{item.value}</span>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // --- LIVE DATA STORE ---
    function useLiveMarkets(){
      const [markets, setMarkets] = useState([]);
      const [fedMarkets, setFedMarkets] = useState([]);
      const [status, setStatus] = useState('connecting');
      const [error, setError] = useState(null);

      // Initial fetch of all markets
      useEffect(()=>{
        fetch(`${API_BASE}/markets`)
          .then(async r => {
            if(!r.ok) throw new Error(`GET /markets ${r.status}`);
            return await r.json();
          })
          .then(data => setMarkets(Array.isArray(data) ? data : []))
          .catch(e => setError(String(e)));
      }, []);

      // Fetch Fed markets specifically
      useEffect(()=>{
        const fetchFedMarkets = async () => {
          try {
            const response = await fetch(`${API_BASE}/fed-markets`);
            if (!response.ok) throw new Error(`GET /fed-markets ${response.status}`);
            const data = await response.json();
            setFedMarkets(data.markets || []);
          } catch (e) {
            console.error('Error fetching Fed markets:', e);
          }
        };
        
        fetchFedMarkets();
        const interval = setInterval(fetchFedMarkets, 30000); // Refresh every 30 seconds
        
        return () => clearInterval(interval);
      }, []);

      // SSE updates
      useEffect(()=>{
        const es = new EventSource(`${API_BASE}/stream`);
        es.onopen = () => setStatus('live');
        es.onmessage = (ev) => {
          try {
            const payload = JSON.parse(ev.data);
            if (payload.type === 'upsert' && Array.isArray(payload.markets)) {
              setMarkets(prev => {
                const byT = Object.fromEntries(prev.map(m => [m.ticker, m]));
                for (const u of payload.markets) {
                  if (u.ticker) byT[u.ticker] = { ...(byT[u.ticker]||{ ticker: u.ticker, title: u.ticker }), ...u };
                }
                return Object.values(byT).sort((a,b)=>a.ticker.localeCompare(b.ticker));
              });
              
              // Update Fed markets if they're in the update
              setFedMarkets(prev => {
                const updated = [...prev];
                for (const u of payload.markets) {
                  if (u.ticker && u.ticker.startsWith('KXRATECUTCOUNT')) {
                    const idx = updated.findIndex(m => m.ticker === u.ticker);
                    if (idx >= 0) {
                      updated[idx] = { ...updated[idx], ...u };
                    }
                  }
                }
                return updated;
              });
            }
          } catch {}
        };
        es.onerror = () => setStatus('disconnected');
        return () => es.close();
      }, []);

      return { markets, fedMarkets, setMarkets, status, error };
    }

    // --- HEDGE ANYTHING COMPONENT ---
    function HedgeAnything({ markets, fedMarkets }) {
      const [hedgeType, setHedgeType] = useState('mortgage');
      const [userProfile, setUserProfile] = useState({
        mortgage: {
          principal: 400000,
          rate: 7.0,
          yearsRemaining: 25,
          desiredRate: 5.5
        }
      });
      
      // Total hedge amount and individual allocations
      const [totalHedgeAmount, setTotalHedgeAmount] = useState(null);
      const [marketAllocations, setMarketAllocations] = useState({});
      const [autoAllocate, setAutoAllocate] = useState(true);

      // Calculate mortgage hedging strategy
      const mortgageHedge = useMemo(() => {
        const { principal, rate, yearsRemaining, desiredRate } = userProfile.mortgage;
        const monthlyPayments = yearsRemaining * 12;
        
        // Calculate current monthly payment
        const monthlyRate = rate / 100 / 12;
        const currentMonthly = principal * (monthlyRate * Math.pow(1 + monthlyRate, monthlyPayments)) / 
                              (Math.pow(1 + monthlyRate, monthlyPayments) - 1);
        
        // Calculate potential monthly payment at desired rate
        const desiredMonthlyRate = desiredRate / 100 / 12;
        const desiredMonthly = principal * (desiredMonthlyRate * Math.pow(1 + desiredMonthlyRate, monthlyPayments)) / 
                              (Math.pow(1 + desiredMonthlyRate, monthlyPayments) - 1);
        
        // Calculate total savings if rates drop
        const monthlySavings = currentMonthly - desiredMonthly;
        const totalSavings = monthlySavings * monthlyPayments;
        const yearlySavings = monthlySavings * 12;
        
        // Basis points difference
        const bpsDifference = (rate - desiredRate) * 100;
        const requiredCuts = Math.ceil(bpsDifference / 25); // Assuming 25bp per cut
        
        return {
          currentMonthly: currentMonthly.toFixed(2),
          desiredMonthly: desiredMonthly.toFixed(2),
          monthlySavings: monthlySavings.toFixed(2),
          yearlySavings: yearlySavings.toFixed(2),
          totalSavings: totalSavings.toFixed(0),
          requiredCuts,
          bpsDifference: bpsDifference.toFixed(0)
        };
      }, [userProfile.mortgage]);

      // Set initial total hedge amount
      useEffect(() => {
        if (totalHedgeAmount === null && mortgageHedge.yearlySavings) {
          setTotalHedgeAmount(parseFloat(mortgageHedge.yearlySavings));
        }
      }, [mortgageHedge.yearlySavings]);

      // Auto-allocate across markets based on liquidity and probability
      useEffect(() => {
        if (!autoAllocate || !fedMarkets.length || !totalHedgeAmount) return;
        
        const allocations = {};
        const totalLiquidity = fedMarkets.reduce((sum, m) => sum + (m.liquidity_score || 50), 0);
        
        // Allocate based on liquidity score and proximity to required cuts
        fedMarkets.forEach(market => {
          const weight = (market.liquidity_score || 50) / totalLiquidity;
          
          // Boost allocation for markets near the required cuts
          const cutsDiff = Math.abs(market.cuts - mortgageHedge.requiredCuts);
          const proximityBoost = cutsDiff <= 1 ? 1.5 : cutsDiff <= 2 ? 1.2 : 1.0;
          
          allocations[market.ticker] = Math.round(totalHedgeAmount * weight * proximityBoost);
        });
        
        // Normalize to match total
        const allocSum = Object.values(allocations).reduce((a, b) => a + b, 0);
        if (allocSum > 0) {
          Object.keys(allocations).forEach(ticker => {
            allocations[ticker] = Math.round(allocations[ticker] * totalHedgeAmount / allocSum);
          });
        }
        
        setMarketAllocations(allocations);
      }, [autoAllocate, fedMarkets, totalHedgeAmount, mortgageHedge.requiredCuts]);

      // Calculate potential returns for each market
      const calculateReturns = (market, hedgeAmount) => {
        if (!hedgeAmount || !market.no_price) return null;
        
        const noPrice = market.no_price / 100; // Convert cents to dollars
        const potentialPayout = hedgeAmount / noPrice;
        const netProfit = potentialPayout - hedgeAmount;
        const returnMultiple = 1 / noPrice;
        
        return {
          hedgeAmount: hedgeAmount.toFixed(2),
          potentialPayout: potentialPayout.toFixed(2),
          netProfit: netProfit.toFixed(2),
          returnMultiple: returnMultiple.toFixed(2)
        };
      };

      // Calculate total portfolio metrics
      const portfolioMetrics = useMemo(() => {
        let totalInvested = 0;
        let totalPotentialPayout = 0;
        let weightedReturn = 0;
        
        fedMarkets.forEach(market => {
          const allocation = marketAllocations[market.ticker] || 0;
          if (allocation > 0) {
            const returns = calculateReturns(market, allocation);
            if (returns) {
              totalInvested += allocation;
              totalPotentialPayout += parseFloat(returns.potentialPayout);
              weightedReturn += parseFloat(returns.returnMultiple) * (allocation / (totalHedgeAmount || 1));
            }
          }
        });
        
        return {
          totalInvested: totalInvested.toFixed(2),
          totalPotentialPayout: totalPotentialPayout.toFixed(2),
          netProfit: (totalPotentialPayout - totalInvested).toFixed(2),
          averageReturn: weightedReturn.toFixed(2),
          coverage: ((totalPotentialPayout / parseFloat(mortgageHedge.yearlySavings)) * 100).toFixed(1)
        };
      }, [fedMarkets, marketAllocations, totalHedgeAmount, mortgageHedge.yearlySavings]);

      // Chart data for allocation visualization
      const allocationChartData = useMemo(() => {
        return fedMarkets
          .filter(m => marketAllocations[m.ticker] > 0)
          .map(m => ({
            name: `${m.cuts} cuts`,
            value: marketAllocations[m.ticker],
            ticker: m.ticker
          }));
      }, [fedMarkets, marketAllocations]);

      return (
        <div>
          {/* Header Section */}
          <div className="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg p-8 mb-6">
            <h2 className="text-3xl font-bold mb-4">üõ°Ô∏è Hedge Anything</h2>
            <p className="text-lg mb-4 text-purple-100">
              Turn life's uncertainties into opportunities. Use prediction markets to protect against financial risks.
            </p>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
              <button onClick={() => setHedgeType('mortgage')} 
                      className={`p-3 rounded-lg font-medium transition ${hedgeType==='mortgage' ? 'bg-white text-purple-600' : 'bg-purple-500/20 hover:bg-purple-500/30'}`}>
                üè† Mortgage Rates
              </button>
              <button className="p-3 rounded-lg bg-purple-500/20 hover:bg-purple-500/30 font-medium opacity-50 cursor-not-allowed">
                ‚òÅÔ∏è Weather (Coming Soon)
              </button>
              <button className="p-3 rounded-lg bg-purple-500/20 hover:bg-purple-500/30 font-medium opacity-50 cursor-not-allowed">
                üèÜ Sports (Coming Soon)
              </button>
              <button className="p-3 rounded-lg bg-purple-500/20 hover:bg-purple-500/30 font-medium opacity-50 cursor-not-allowed">
                üõí Inflation (Coming Soon)
              </button>
            </div>
          </div>

          {hedgeType === 'mortgage' && (
            <>
              {/* Mortgage Input Form */}
              <div className="bg-white rounded-lg shadow p-6 mb-6">
                <h3 className="text-xl font-bold mb-4">Your Mortgage Details</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Remaining Principal Balance
                    </label>
                    <div className="relative">
                      <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                      <input 
                        type="number" 
                        value={userProfile.mortgage.principal}
                        onChange={e => setUserProfile(prev => ({
                          ...prev, 
                          mortgage: {...prev.mortgage, principal: parseInt(e.target.value) || 0}
                        }))}
                        className="w-full pl-8 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Current Interest Rate (%)
                    </label>
                    <input 
                      type="number" 
                      step="0.1"
                      value={userProfile.mortgage.rate}
                      onChange={e => setUserProfile(prev => ({
                        ...prev, 
                        mortgage: {...prev.mortgage, rate: parseFloat(e.target.value) || 0}
                      }))}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Years Remaining
                    </label>
                    <input 
                      type="number" 
                      value={userProfile.mortgage.yearsRemaining}
                      onChange={e => setUserProfile(prev => ({
                        ...prev, 
                        mortgage: {...prev.mortgage, yearsRemaining: parseInt(e.target.value) || 0}
                      }))}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Target Refinance Rate (%)
                    </label>
                    <input 
                      type="number" 
                      step="0.1"
                      value={userProfile.mortgage.desiredRate}
                      onChange={e => setUserProfile(prev => ({
                        ...prev, 
                        mortgage: {...prev.mortgage, desiredRate: parseFloat(e.target.value) || 0}
                      }))}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </div>
              </div>

              {/* Analysis Results */}
              <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                <h3 className="text-xl font-bold mb-4 text-blue-900">Your Refinancing Analysis</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-white rounded-lg p-4">
                    <p className="text-sm text-gray-600">Current Monthly</p>
                    <p className="text-2xl font-bold">${mortgageHedge.currentMonthly}</p>
                  </div>
                  <div className="bg-white rounded-lg p-4">
                    <p className="text-sm text-gray-600">Target Monthly</p>
                    <p className="text-2xl font-bold text-green-600">${mortgageHedge.desiredMonthly}</p>
                  </div>
                  <div className="bg-white rounded-lg p-4">
                    <p className="text-sm text-gray-600">Monthly Savings</p>
                    <p className="text-2xl font-bold text-blue-600">${mortgageHedge.monthlySavings}</p>
                  </div>
                  <div className="bg-white rounded-lg p-4">
                    <p className="text-sm text-gray-600">Yearly Savings</p>
                    <p className="text-2xl font-bold text-purple-600">${mortgageHedge.yearlySavings}</p>
                  </div>
                </div>
                <div className="mt-4 p-4 bg-yellow-50 rounded-lg">
                  <p className="text-sm text-yellow-800">
                    <strong>Analysis:</strong> You need approximately {mortgageHedge.requiredCuts} rate cuts of 25 basis points each 
                    to reach your target refinancing rate. That's a total of {mortgageHedge.bpsDifference} basis points.
                  </p>
                </div>
              </div>

              {/* Hedge Configuration */}
              <div className="bg-white rounded-lg shadow p-6 mb-6">
                <h3 className="text-xl font-bold mb-4">‚öôÔ∏è Configure Your Hedge</h3>
                
                <div className="mb-6">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Total Hedge Amount (Recommended: 1 year of savings = ${mortgageHedge.yearlySavings})
                  </label>
                  <div className="flex items-center gap-4">
                    <div className="relative flex-1">
                      <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                      <input 
                        type="number"
                        value={totalHedgeAmount || ''}
                        onChange={e => {
                          setTotalHedgeAmount(parseFloat(e.target.value) || 0);
                          setAutoAllocate(true); // Re-allocate when total changes
                        }}
                        className="w-full pl-8 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <button 
                      onClick={() => setTotalHedgeAmount(parseFloat(mortgageHedge.yearlySavings))}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                    >
                      Use Recommended
                    </button>
                  </div>
                </div>

                <div className="flex items-center justify-between mb-4">
                  <h4 className="font-semibold">Allocation Strategy</h4>
                  <label className="flex items-center">
                    <input 
                      type="checkbox"
                      checked={autoAllocate}
                      onChange={e => setAutoAllocate(e.target.checked)}
                      className="mr-2"
                    />
                    <span className="text-sm">Auto-allocate based on liquidity</span>
                  </label>
                </div>

                {/* Portfolio Summary */}
                <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6 p-4 bg-gray-50 rounded-lg">
                  <div>
                    <p className="text-xs text-gray-600">Total Investment</p>
                    <p className="font-bold text-lg">${portfolioMetrics.totalInvested}</p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-600">Potential Payout</p>
                    <p className="font-bold text-lg text-green-600">${portfolioMetrics.totalPotentialPayout}</p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-600">Net Profit</p>
                    <p className="font-bold text-lg text-blue-600">${portfolioMetrics.netProfit}</p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-600">Avg Return</p>
                    <p className="font-bold text-lg">{portfolioMetrics.averageReturn}x</p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-600">Coverage</p>
                    <p className="font-bold text-lg text-purple-600">{portfolioMetrics.coverage}%</p>
                  </div>
                </div>

                {/* Allocation Visualization */}
                {window.Recharts && allocationChartData.length > 0 && (
                  <div className="mb-6">
                    <h4 className="font-semibold mb-2">Allocation Distribution</h4>
                    <ResponsiveContainer width="100%" height={200}>
                      <BarChart data={allocationChartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="name" />
                        <YAxis />
                        <Tooltip formatter={(value) => `$${value}`} />
                        <Bar dataKey="value" fill="#8b5cf6" />
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                )}
              </div>

              {/* Individual Market Allocations */}
              <div className="bg-white rounded-lg shadow p-6">
                <h3 className="text-xl font-bold mb-4">üìä Fed Rate Cut Markets - Adjust Your Hedge</h3>
                <p className="text-gray-600 mb-6">
                  These are the most liquid KXRATECUTCOUNT markets. Adjust individual allocations to fine-tune your hedge.
                </p>
                
                {fedMarkets.length > 0 ? (
                  <div className="space-y-4">
                    {fedMarkets.map((market, idx) => {
                      const allocation = marketAllocations[market.ticker] || 0;
                      const returns = calculateReturns(market, allocation);
                      
                      return (
                        <div key={idx} className="hedge-card border rounded-lg p-4 hover:bg-gray-50">
                          <div className="flex justify-between items-start mb-3">
                            <div className="flex-1">
                              <h4 className="font-semibold text-lg">{market.title || `${market.cuts} Rate Cuts`}</h4>
                              <p className="text-sm text-gray-500 font-mono">{market.ticker}</p>
                              <div className="flex items-center gap-4 mt-1">
                                <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
                                  Liquidity: {market.liquidity_score}/100
                                </span>
                                <span className="text-xs text-gray-500">
                                  Volume: {(market.volume || 0).toLocaleString()}
                                </span>
                              </div>
                            </div>
                            <div className="text-right">
                              <span className="text-sm text-gray-500">NO Price</span>
                              <p className="text-xl font-bold text-red-600">{market.no_price}¬¢</p>
                              <p className="text-xs text-gray-400">
                                Spread: {market.spread || 1}¬¢
                              </p>
                            </div>
                          </div>
                          
                          {/* Allocation Slider */}
                          <div className="allocation-slider bg-gray-50 rounded-lg p-3 mb-3">
                            <div className="flex justify-between items-center mb-2">
                              <label className="text-sm font-medium">Allocation Amount</label>
                              <div className="flex items-center gap-2">
                                <span className="text-sm text-gray-600">$</span>
                                <input
                                  type="number"
                                  value={allocation}
                                  onChange={e => {
                                    const newValue = Math.max(0, parseFloat(e.target.value) || 0);
                                    setMarketAllocations(prev => ({
                                      ...prev,
                                      [market.ticker]: newValue
                                    }));
                                    setAutoAllocate(false);
                                  }}
                                  className="w-24 px-2 py-1 border rounded text-sm"
                                />
                              </div>
                            </div>
                            <input
                              type="range"
                              min="0"
                              max={totalHedgeAmount || 1000}
                              step="10"
                              value={allocation}
                              onChange={e => {
                                setMarketAllocations(prev => ({
                                  ...prev,
                                  [market.ticker]: parseFloat(e.target.value)
                                }));
                                setAutoAllocate(false);
                              }}
                              className="w-full"
                            />
                          </div>
                          
                          {/* Returns Display */}
                          {returns && allocation > 0 && (
                            <div className="grid grid-cols-3 gap-4 p-3 bg-blue-50 rounded">
                              <div>
                                <p className="text-xs text-gray-600">If Rates Stay High</p>
                                <p className="font-bold text-green-600">${returns.potentialPayout}</p>
                                <p className="text-xs text-gray-500">{returns.returnMultiple}x return</p>
                              </div>
                              <div>
                                <p className="text-xs text-gray-600">Net Profit</p>
                                <p className="font-bold">${returns.netProfit}</p>
                                <p className="text-xs text-gray-500">From ${returns.hedgeAmount}</p>
                              </div>
                              <div>
                                <p className="text-xs text-gray-600">Savings Coverage</p>
                                <p className="font-bold text-purple-600">
                                  {((parseFloat(returns.netProfit) / parseFloat(mortgageHedge.yearlySavings)) * 100).toFixed(1)}%
                                </p>
                                <p className="text-xs text-gray-500">Of yearly savings</p>
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <p className="text-xl mb-4">Loading Fed rate markets...</p>
                    <p className="text-sm">Searching for KXRATECUTCOUNT markets with good liquidity</p>
                  </div>
                )}
                
                <div className="mt-6 p-4 bg-gray-100 rounded-lg">
                  <p className="text-xs text-gray-600">
                    <strong>How it works:</strong> You're betting on "NO rate cuts" for each scenario. If the Fed doesn't cut rates 
                    as much as expected, your mortgage stays expensive BUT your hedge pays out to offset the lost savings. 
                    Adjust allocations based on which scenarios you think are most likely.
                  </p>
                </div>
                
                <div className="mt-4 p-4 bg-yellow-50 rounded-lg">
                  <p className="text-xs text-gray-600">
                    <strong>Disclaimer:</strong> This is not financial advice. Hedging strategies involve risk and may result in losses. 
                    Mortgage rates are influenced by many factors beyond Fed policy. Please consult with a financial advisor.
                  </p>
                </div>
              </div>
            </>
          )}
        </div>
      );
    }

    // --- MARKET CARD ---
    function MarketCard({ market, isSelected, onClick }) {
      const volatility = market.volatility ?? 6.0;
      const getVolatilityColor = (vol) => {
        if (vol > 8) return 'bg-red-100 text-red-600';
        if (vol > 6) return 'bg-yellow-100 text-yellow-600';
        return 'bg-green-100 text-green-600';
      };
      return (
        <div onClick={onClick}
             className={`market-card p-4 rounded-lg border-2 cursor-pointer transition-all ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}>
          <div className="flex justify-between items-start mb-2">
            <span className="font-mono text-sm text-gray-500">{market.ticker}</span>
            <span className={`text-xs px-2 py-1 rounded-full ${getVolatilityColor(volatility)}`}>
              œÉ{volatility}
            </span>
          </div>
          <h4 className="font-medium text-sm mb-2">{market.title || market.ticker}</h4>
          <div className="flex justify-between items-center text-xs text-gray-500">
            <span>{fallback(market.volume_24h, 0).toLocaleString()} vol</span>
            <span className="bg-gray-100 px-2 py-1 rounded">{market.category || 'General'}</span>
          </div>
        </div>
      );
    }

    // ... [Include other components like MarketHeader, ImpactCalculator, VolumeVelocity, Comparison] ...

    // --- APP ---
    function App(){
      const [activeTab, setActiveTab] = useState('hedge');
      const { markets, fedMarkets, status, error } = useLiveMarkets();
      const [selectedMarket, setSelectedMarket] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');

      useEffect(()=>{
        if (!markets.length) return;
        if (!selectedMarket) setSelectedMarket(markets[0]);
        else {
          const found = markets.find(m => m.ticker === selectedMarket.ticker);
          if (found) setSelectedMarket(found);
        }
      }, [markets]);

      const filteredMarkets = useMemo(()=>{
        const data = markets || [];
        if (!searchQuery) return data;
        const q = searchQuery.toLowerCase();
        return data.filter(m => (m.ticker||'').toLowerCase().includes(q) || (m.title||'').toLowerCase().includes(q));
      }, [markets, searchQuery]);

      const statusChip = status === 'live' ? 'bg-green-600' : (status === 'connecting' ? 'bg-yellow-600' : 'bg-red-600');

      return (
        <div className="min-h-screen bg-gray-50">
          <header className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 shadow-lg">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold">Kalshi Market Tools</h1>
                <p className="text-blue-100 mt-1">Advanced analytics & hedging for event contract trading</p>
              </div>
              <span className={"px-3 py-1 rounded-full text-sm " + statusChip}>
                {status === 'live' ? 'Live data' : status === 'connecting' ? 'Connecting‚Ä¶' : 'Disconnected'}
              </span>
            </div>
          </header>

          <nav className="bg-white shadow-sm">
            <div className="flex space-x-8 px-6 overflow-x-auto">
              <button onClick={()=>setActiveTab('hedge')} className={"py-4 px-2 font-medium transition whitespace-nowrap " + (activeTab==='hedge'?'tab-active':'text-gray-600')}>üõ°Ô∏è Hedge Anything</button>
            </div>
          </nav>

          <main className="container mx-auto px-6 py-6">
            <HedgeAnything markets={markets} fedMarkets={fedMarkets} />
          </main>

          <footer className="bg-gray-800 text-white mt-12 py-8">
            <div className="container mx-auto px-6">
              <div className="text-center text-sm text-gray-400">
                <p>¬© 2025 Kalshi Market Tools ‚Ä¢ For demonstration purposes ‚Ä¢ Not financial advice</p>
              </div>
            </div>
          </footer>
        </div>
      );
    }

    // Render
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => ReactDOM.render(<App />, document.getElementById('root')));
    } else {
      ReactDOM.render(<App />, document.getElementById('root'));
    }
  </script>
</body>
</html>