<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalshi Market Tools</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 17 + ReactDOM 17 -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.production.min.js?v=4"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.production.min.js?v=4"></script>

  <!-- PropTypes must come before Recharts -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js?v=4"></script>
  <!-- Recharts (UMD) -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/recharts@2.9.0/umd/Recharts.min.js?v=4"></script>

  <!-- Babel for JSX (dev) -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.7/babel.min.js?v=4"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
    .market-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .skeleton { background: linear-gradient(90deg, #111827 25%, #1f2937 50%, #111827 75%); background-size: 1000px 100%; animation: loading 2s infinite; }
    @keyframes loading { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
    .kalshi-link { color: #3b82f6; text-decoration: none; }
    .kalshi-link:hover { text-decoration: underline; }
    .dispute-indicator { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root">Loading...</div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const RechartsLib = window.Recharts || {};
    const { LineChart, Line, BarChart, Bar, ComposedChart, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell } = RechartsLib;

    // --- CONFIG ---
    const params = new URLSearchParams(location.search);
    const API_BASE = params.get('api') || "https://kalshi-market-tools-production.up.railway.app";
    const KALSHI_BASE = "https://kalshi.com/markets";

    // --- UTIL ---
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const fallback = (v, d) => (v === undefined || v === null ? d : v);
    
    // Generate Kalshi market URL
    const getKalshiUrl = (ticker) => `${KALSHI_BASE}/${ticker}`;

    // --- SIMPLE FALLBACK CHART ---
    const SimpleChart = ({ data, title }) => {
      if (!data || data.length === 0) return null;
      const maxValue = Math.max(...data.map(d => d.value || 0), 1);
      return (
        <div className="bg-white rounded-lg shadow p-4">
          <h4 className="text-sm font-semibold mb-3">{title}</h4>
          <div className="space-y-2">
            {data.slice(0, 10).map((item, i) => (
              <div key={i} className="flex items-center">
                <span className="text-xs w-16">{item.label}</span>
                <div className="flex-1 mx-2">
                  <div className="h-4 bg-blue-500 rounded" style={{ width: `${(item.value / maxValue) * 100}%` }}></div>
                </div>
                <span className="text-xs">{item.value}</span>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // --- LIVE DATA STORE ---
    
    // --- LIVE DATA STORE ---
    function useLiveMarkets(){
      const [markets, setMarkets] = useState([]);
      const [status, setStatus] = useState('connecting');
      const [error, setError] = useState(null);

      useEffect(()=>{
        fetch(`${API_BASE}/markets`)
          .then(async r => {
            if(!r.ok) throw new Error(`GET /markets ${r.status}`);
            return await r.json();
          })
          .then(data => setMarkets(Array.isArray(data) ? data : []))
          .catch(e => setError(String(e)));
      }, []);

      useEffect(()=>{
        const es = new EventSource(`${API_BASE}/stream`);
        es.onopen = () => setStatus('live');
        es.onmessage = (ev) => {
          try {
            const payload = JSON.parse(ev.data);
            if (payload.type === 'upsert' && Array.isArray(payload.markets)) {
              setMarkets(prev => {
                const byT = Object.fromEntries(prev.map(m => [m.ticker, m]));
                for (const u of payload.markets) {
                  if (u.ticker) byT[u.ticker] = { ...(byT[u.ticker]||{ ticker: u.ticker, title: u.ticker }), ...u };
                }
                return Object.values(byT).sort((a,b)=>a.ticker.localeCompare(b.ticker));
              });
            }
          } catch {}
        };
        es.onerror = () => setStatus('disconnected');
        return () => es.close();
      }, []);

      return { markets, setMarkets, status, error };
    }

    // --- MARKET CARD ---
    function MarketCard({ market, isSelected, onClick }) {
      const volatility = market.volatility ?? 6.0;
      const getVolatilityColor = (vol) => {
        if (vol > 8) return 'bg-red-100 text-red-600';
        if (vol > 6) return 'bg-yellow-100 text-yellow-600';
        return 'bg-green-100 text-green-600';
      };
      return (
        <div onClick={onClick}
             className={`market-card p-4 rounded-lg border-2 cursor-pointer transition-all ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}>
          <div className="flex justify-between items-start mb-2">
            <span className="font-mono text-sm text-gray-500">{market.ticker}</span>
            <span className={`text-xs px-2 py-1 rounded-full ${getVolatilityColor(volatility)}`}>
              Ïƒ{volatility}
            </span>
          </div>
          <h4 className="font-medium text-sm mb-2">{market.title || market.ticker}</h4>
          <div className="flex justify-between items-center text-xs text-gray-500">
            <span>{fallback(market.volume_24h, 0).toLocaleString()} vol</span>
            <span className="bg-gray-100 px-2 py-1 rounded">{market.category || 'General'}</span>
          </div>
        </div>
      );
    }

    // --- MARKET HEADER ---
    function MarketHeader({ market }) {
      if (!market) return null;
      const yes_price = fallback(market.yes_price, 0);
      const no_price = fallback(market.no_price, 0);
      const yes_bid = fallback(market.yes_bid, Math.max(0, yes_price - 1));
      const yes_ask = fallback(market.yes_ask, Math.min(100, yes_price + 1));
      const no_bid = fallback(market.no_bid, Math.max(0, no_price - 1));
      const no_ask = fallback(market.no_ask, Math.min(100, no_price + 1));
      const spreadPct = yes_price ? ((yes_ask - yes_bid) / yes_price * 100) : 0;

      return (
        <div className="bg-white rounded-lg shadow p-6 mb-6">
          <div className="mb-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-500 font-mono">{market.ticker}</p>
                <h2 className="text-2xl font-bold">{market.title || market.ticker}</h2>
              </div>
              <a href={getKalshiUrl(market.ticker)} 
                 target="_blank" 
                 rel="noopener noreferrer"
                 className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                Trade on Kalshi
              </a>
            </div>
          </div>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <p className="text-xs text-gray-500">YES Price</p>
              <p className="text-2xl font-bold text-green-600">{yes_price}Â¢</p>
              <p className="text-xs text-gray-400">B: {yes_bid}Â¢ / A: {yes_ask}Â¢</p>
            </div>
            <div>
              <p className="text-xs text-gray-500">NO Price</p>
              <p className="text-2xl font-bold text-red-600">{no_price}Â¢</p>
              <p className="text-xs text-gray-400">B: {no_bid}Â¢ / A: {no_ask}Â¢</p>
            </div>
            <div>
              <p className="text-xs text-gray-500">Volume</p>
              <p className="text-xl font-semibold">{fallback(market.volume_24h, 0).toLocaleString()}</p>
            </div>
            <div>
              <p className="text-xs text-gray-500">Spread</p>
              <p className="text-xl font-semibold">{spreadPct.toFixed(1)}%</p>
            </div>
          </div>
        </div>
      );
    }

    // --- IMPACT CALCULATOR ---
    function ImpactCalculator({ market }) {
      const [side, setSide] = useState('yes');
      const [quantity, setQuantity] = useState(100);
      const [impact, setImpact] = useState(null);

      const generateImpact = (quantity, side, market) => {
        const base = side === 'yes' ? fallback(market.yes_price, 0) : fallback(market.no_price, 0);
        const levels = [];
        let remaining = quantity, totalCost = 0, totalFilled = 0;
        for (let i=0; i<5 && remaining>0; i++){
          const levelPx = base + i*0.5;
          const levelQty = i===0 ? 200 : 300;
          const fill = Math.min(remaining, levelQty);
          const rem  = levelQty - fill;
          if (fill>0){
            levels.push({ price: levelPx, filled: fill, remaining: rem });
            totalCost += fill * levelPx;
            totalFilled += fill;
            remaining -= fill;
          }
        }
        const avgPrice = totalFilled ? totalCost/totalFilled : base;
        const slippage = base ? ((avgPrice - base)/base*100) : 0;
        const fillRate = totalFilled/quantity*100;
        return { avg_price: avgPrice, total_cost: totalCost/100, slippage, fill_rate: fillRate, levels_consumed: levels };
      };

      useEffect(() => { if (market) setImpact(generateImpact(quantity, side, market)); }, [market, quantity, side]);

      const chartData = useMemo(() => {
        if (!market) return [];
        const base = side === 'yes' ? fallback(market.yes_price, 0) : fallback(market.no_price, 0);
        const pts = [];
        for (let q=10; q<=2000; q+=100){
          const imp = generateImpact(q, side, market);
          pts.push({ quantity: q, marketPrice: base, executionPrice: imp.avg_price, slippage: imp.slippage });
        }
        return pts;
      }, [market, side]);

      if (!market) return <div className="text-center py-12 text-gray-500"><p className="text-xl">Select a market to calculate order impact</p></div>;

      return (
        <div>
          <MarketHeader market={market} />
          <div className="bg-white rounded-lg shadow p-6 mb-6">
            <h3 className="text-lg font-semibold mb-4">Order Configuration</h3>
            <div className="space-y-4">
              <div>
                <label className="text-sm font-medium text-gray-700">Side</label>
                <div className="flex gap-2 mt-1">
                  <button onClick={() => setSide('yes')} className={`flex-1 py-2 rounded-lg font-medium transition ${side==='yes'?'bg-green-500 text-white':'bg-gray-100'}`}>YES</button>
                  <button onClick={() => setSide('no')}  className={`flex-1 py-2 rounded-lg font-medium transition ${side==='no'?'bg-red-500 text-white':'bg-gray-100'}`}>NO</button>
                </div>
              </div>
              <div>
                <label className="text-sm font-medium text-gray-700">Order Size: {quantity} contracts</label>
                <input type="range" min="10" max="2000" step="10" value={quantity} onChange={e=>setQuantity(parseInt(e.target.value))} className="w-full mt-2"/>
              </div>
            </div>
          </div>

          {impact && (
            <>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div className="bg-blue-50 p-4 rounded-lg"><p className="text-sm text-gray-600">Avg Price</p><p className="text-2xl font-bold text-blue-600">{impact.avg_price.toFixed(1)}Â¢</p></div>
                <div className="bg-purple-50 p-4 rounded-lg"><p className="text-sm text-gray-600">Total Cost</p><p className="text-2xl font-bold text-purple-600">${impact.total_cost.toFixed(2)}</p></div>
                <div className="bg-orange-50 p-4 rounded-lg"><p className="text-sm text-gray-600">Slippage</p><p className="text-2xl font-bold text-orange-600">{impact.slippage.toFixed(1)}%</p></div>
                <div className="bg-green-50 p-4 rounded-lg"><p className="text-sm text-gray-600">Fill Rate</p><p className="text-2xl font-bold text-green-600">{impact.fill_rate.toFixed(0)}%</p></div>
              </div>

              {window.Recharts ? (
                <div className="bg-white rounded-lg shadow p-6">
                  <h3 className="text-lg font-semibold mb-2">Price Impact Visualization</h3>
                  <ResponsiveContainer width="100%" height={350}>
                    <ComposedChart data={chartData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                      <XAxis dataKey="quantity" label={{ value: 'Order Size (contracts)', position: 'insideBottom', offset: -5 }} stroke="#6b7280"/>
                      <YAxis label={{ value: 'Price (Â¢)', angle: -90, position: 'insideLeft' }} stroke="#6b7280" domain={['dataMin - 2', 'dataMax + 2']}/>
                      <Tooltip /><Legend />
                      <Area type="monotone" dataKey="executionPrice" fill="#3b82f633" stroke="none"/>
                      <Line type="monotone" dataKey="marketPrice" stroke="#9ca3af" strokeDasharray="5 5" name="Market Price" strokeWidth={2} dot={false}/>
                      <Line type="monotone" dataKey="executionPrice" stroke="#3b82f6" name="Your Execution Price" strokeWidth={3} dot={{ r: 3 }}/>
                    </ComposedChart>
                  </ResponsiveContainer>
                </div>
              ) : (
                <SimpleChart data={chartData.map(d => ({ label: `${d.quantity}`, value: d.executionPrice }))} title="Price Impact by Order Size"/>
              )}
            </>
          )}
        </div>
      );
    }

    // --- VOLUME VELOCITY ---
    function VolumeVelocity({ market }){
      const [data, setData] = useState(null);
      useEffect(()=>{
        if (!market) return;
        const baseVol = fallback(market.volume_24h, 0);
        const yes = fallback(market.yes_price, 50);
        setData({
          metrics: {
            total_volume: baseVol * 24,
            recent_avg: Math.floor(baseVol * 1.3),
            earlier_avg: Math.floor(baseVol * 0.9),
            velocity_change: 44.4
          },
          peak: { hour: '14:00', volume: Math.floor(baseVol * 2.5), coincided_with_news: Math.random()>0.5 },
          news_events: Math.random()>0.5 ? [{ timestamp: new Date().toISOString(), description: 'Fed announces surprise rate decision', volume_spike: baseVol*2, price_at_event: yes }] : []
        });
      }, [market]);

      const hourlyData = useMemo(()=>{
        if (!data || !market) return [];
        const y = fallback(market.yes_price, 50);
        const hours = [];
        for (let i=0;i<24;i++){
          hours.push({ hour: `${i}:00`, volume: Math.floor(Math.random()*1000+100), price: y + (Math.random()-0.5)*10 });
        }
        hours[14] = { hour: '14:00', volume: 2500, price: y + 3 };
        return hours;
      }, [data, market]);

      if (!market) return <div className="text-center py-12 text-gray-500"><p className="text-xl">Select a market to analyze volume velocity</p></div>;
      if (!data) return null;

      return (
        <div>
          <MarketHeader market={market} />
          {window.Recharts ? (
            <div className="bg-white rounded-lg shadow p-6 mb-6">
              <h3 className="text-lg font-semibold mb-4">Volume & Price Over Time (24h)</h3>
              <ResponsiveContainer width="100%" height={300}>
                <ComposedChart data={hourlyData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
                  <XAxis dataKey="hour" />
                  <YAxis yAxisId="volume" orientation="left" />
                  <YAxis yAxisId="price" orientation="right" />
                  <Tooltip /><Legend />
                  <Bar yAxisId="volume" dataKey="volume" fill="#3b82f6" opacity={0.7} name="Volume"/>
                  <Line yAxisId="price" type="monotone" dataKey="price" stroke="#10b981" strokeWidth={3} name="Price (Â¢)" dot={{ r:2 }}/>
                </ComposedChart>
              </ResponsiveContainer>
            </div>
          ) : (
            <SimpleChart data={hourlyData.map(d => ({ label: d.hour, value: d.volume }))} title="Volume Over Time (24h)"/>
          )}
        </div>
      );
    }

    // --- COMPARISON ---
    function Comparison({ markets }) {
      const [selected, setSelected] = useState([]);
      const toggle = (m) => {
        setSelected(prev => prev.find(x=>x.ticker===m.ticker) ? prev.filter(x=>x.ticker!==m.ticker) : (prev.length<4?[...prev,m]:prev));
      };
      const comparisonData = useMemo(()=>{
        return selected.map(m => ({
          ticker: m.ticker,
          price: fallback(m.yes_price, 0),
          volume: Math.round(fallback(m.volume_24h, 0)/100),
          volatility: 70,
          spread: 10
        }));
      }, [selected]);

      return (
        <div>
          <div className="bg-white rounded-lg shadow p-6 mb-6">
            <h3 className="text-lg font-semibold mb-4">Select Markets to Compare (Max 4)</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              {markets.map(m => (
                <button key={m.ticker} onClick={()=>toggle(m)}
                        className={`p-3 rounded-lg border-2 transition ${selected.find(x=>x.ticker===m.ticker)?'border-blue-500 bg-blue-50':'border-gray-200 hover:border-gray-300'}`}>
                  <p className="font-mono text-xs">{m.ticker}</p>
                  <p className="text-sm">{(m.title||m.ticker).substring(0,40)}...</p>
                </button>
              ))}
            </div>
          </div>

          {selected.length>1 && (
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-semibold mb-4">Visual Comparison</h3>
              {window.Recharts ? (
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={comparisonData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
                    <XAxis dataKey="ticker" /><YAxis /><Tooltip /><Legend />
                    <Bar dataKey="price" fill="#10b981" name="Price (Â¢)" />
                    <Bar dataKey="volume" fill="#3b82f6" name="Volume (Ã·100)" />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="grid grid-cols-2 gap-4">
                  <SimpleChart data={comparisonData.map(d=>({label:d.ticker, value:d.price}))} title="Price Comparison (Â¢)"/>
                  <SimpleChart data={comparisonData.map(d=>({label:d.ticker, value:d.volume}))} title="Volume Comparison (Ã·100)"/>
                </div>
              )}
            </div>
          )}

          {selected.length===0 && <div className="text-center py-12 text-gray-400"><p className="text-lg">Select at least 2 markets to compare</p></div>}
          {selected.length===1 && <div className="text-center py-12 text-gray-400"><p className="text-lg">Select one more market to start comparison</p></div>}
        </div>
      );
    }

    // --- TECHNICAL ANALYSIS SECTION ---
    function TechnicalAnalysis({ market, markets }) {
      const [subTab, setSubTab] = useState('impact');
      
      return (
        <div>
          <div className="bg-white rounded-lg shadow mb-4">
            <div className="flex border-b">
              <button onClick={()=>setSubTab('impact')} 
                      className={`px-4 py-3 font-medium transition ${subTab==='impact'?'border-b-2 border-blue-500 text-blue-600':'text-gray-600'}`}>
                Market Impact
              </button>
              <button onClick={()=>setSubTab('velocity')} 
                      className={`px-4 py-3 font-medium transition ${subTab==='velocity'?'border-b-2 border-blue-500 text-blue-600':'text-gray-600'}`}>
                Volume Velocity
              </button>
              <button onClick={()=>setSubTab('comparison')} 
                      className={`px-4 py-3 font-medium transition ${subTab==='comparison'?'border-b-2 border-blue-500 text-blue-600':'text-gray-600'}`}>
                Multi-Market
              </button>
            </div>
          </div>
          
          {subTab === 'impact' && <ImpactCalculator market={market} />}
          {subTab === 'velocity' && <VolumeVelocity market={market} />}
          {subTab === 'comparison' && <Comparison markets={markets} />}
        </div>
      );
    }

    // --- MARKET DISPUTES TAB ---
    function MarketDisputes() {
      const [disputes, setDisputes] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedDispute, setSelectedDispute] = useState(null);

      useEffect(() => {
        // Fetch historical dispute data
        fetch(`${API_BASE}/disputes`)
          .then(r => r.json())
          .then(data => {
            setDisputes(data.disputes || []);
            setLoading(false);
          })
          .catch(e => {
            console.error('Error fetching disputes:', e);
            setLoading(false);
            // Mock data for testing
            setDisputes([
              {
                ticker: "TENNIS-CINCY-AUG2025",
                title: "Medvedev vs. Alcaraz - Cincinnati Open Final",
                date: "2025-08-18",
                status: "early_settlement",
                reason: "Player withdrawal - injury",
                settlement_price: 100,
                volume_at_settlement: 45000,
                abnormal_pattern: true,
                description: "Market settled early due to Medvedev withdrawal with ankle injury in second set"
              }
            ]);
          });
      }, []);

      const DisputeCard = ({ dispute }) => (
        <div className={`p-4 rounded-lg border-2 ${dispute.abnormal_pattern ? 'border-red-400 bg-red-50' : 'border-gray-200'}`}>
          <div className="flex justify-between items-start mb-2">
            <div>
              <h4 className="font-semibold">{dispute.title}</h4>
              <p className="text-sm text-gray-600 font-mono">{dispute.ticker}</p>
            </div>
            {dispute.abnormal_pattern && (
              <span className="px-2 py-1 bg-red-600 text-white text-xs rounded-full dispute-indicator">
                DISPUTED
              </span>
            )}
          </div>
          <div className="text-sm text-gray-700">
            <p><strong>Date:</strong> {dispute.date}</p>
            <p><strong>Reason:</strong> {dispute.reason}</p>
            <p><strong>Settlement:</strong> {dispute.settlement_price}Â¢</p>
            <p><strong>Volume:</strong> {dispute.volume_at_settlement?.toLocaleString()}</p>
          </div>
          {dispute.description && (
            <p className="mt-2 text-xs text-gray-600 italic">{dispute.description}</p>
          )}
          <button onClick={() => setSelectedDispute(dispute)}
                  className="mt-3 text-blue-600 hover:text-blue-700 text-sm font-medium">
            View Analysis â†’
          </button>
        </div>
      );

      return (
        <div>
          <div className="bg-white rounded-lg shadow p-6 mb-6">
            <h2 className="text-2xl font-bold mb-4">Market Disputes Analysis</h2>
            <p className="text-gray-600 mb-6">
              Analysis of sports markets that settled early due to player injuries, cancellations, or other unusual circumstances.
            </p>
            
            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
              <p className="text-sm font-semibold text-yellow-800">Testing Environment</p>
              <p className="text-xs text-yellow-700">
                This feature is in development. We're analyzing historical patterns from disputed markets to identify anomalies.
              </p>
            </div>

            {loading ? (
              <div className="text-center py-8">
                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                <p className="mt-2 text-gray-600">Loading dispute data...</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {disputes.map((dispute, idx) => (
                  <DisputeCard key={idx} dispute={dispute} />
                ))}
              </div>
            )}

            {selectedDispute && (
              <div className="mt-8 p-6 bg-gray-50 rounded-lg">
                <h3 className="text-lg font-semibold mb-4">Pattern Analysis: {selectedDispute.ticker}</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <h4 className="font-medium mb-2">Abnormal Market Behavior</h4>
                    <ul className="text-sm text-gray-700 space-y-1">
                      <li>â€¢ Sudden volume spike before announcement</li>
                      <li>â€¢ Price movement inconsistent with public information</li>
                      <li>â€¢ Unusual trading patterns detected</li>
                    </ul>
                  </div>
                  <div>
                    <h4 className="font-medium mb-2">Comparison to Normal Market</h4>
                    <ul className="text-sm text-gray-700 space-y-1">
                      <li>â€¢ Normal markets show gradual price discovery</li>
                      <li>â€¢ Volume typically increases near event time</li>
                      <li>â€¢ This market showed 3x normal volume 2 hours before</li>
                    </ul>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // --- PERSONAL MARKETS TAB ---
    function PersonalMarkets() {
      return (
        <div className="bg-white rounded-lg shadow p-6">
          <div className="text-center py-16">
            <div className="inline-flex items-center justify-center w-16 h-16 bg-purple-100 rounded-full mb-4">
              <svg className="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                      d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            </div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Personal Markets</h2>
            <p className="text-gray-600 mb-6">Create prediction markets with your friends</p>
            
            <div className="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-full">
              <svg className="w-5 h-5 mr-2 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Coming Soon
            </div>
            
            <div className="mt-8 max-w-md mx-auto text-left">
              <h3 className="font-semibold mb-2">Planned Features:</h3>
              <ul className="text-sm text-gray-600 space-y-2">
                <li className="flex items-start">
                  <span className="text-purple-600 mr-2">â€¢</span>
                  Create custom markets for any event
                </li>
                <li className="flex items-start">
                  <span className="text-purple-600 mr-2">â€¢</span>
                  Invite friends via link or social media
                </li>
                <li className="flex items-start">
                  <span className="text-purple-600 mr-2">â€¢</span>
                  Set your own rules and settlement criteria
                </li>
                <li className="flex items-start">
                  <span className="text-purple-600 mr-2">â€¢</span>
                  Track leaderboards and betting history
                </li>
                <li className="flex items-start">
                  <span className="text-purple-600 mr-2">â€¢</span>
                  No real money required - use points or tokens
                </li>
              </ul>
            </div>
          </div>
        </div>
      );
    }

    // --- MAIN APP ---
    function App(){
      const [activeTab, setActiveTab] = useState('technical');
      const { markets, status, error } = useLiveMarkets();
      const [selectedMarket, setSelectedMarket] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');

      useEffect(()=>{
        if (!markets.length) return;
        if (!selectedMarket) setSelectedMarket(markets[0]);
        else {
          const found = markets.find(m => m.ticker === selectedMarket.ticker);
          if (found) setSelectedMarket(found);
        }
      }, [markets]);

      const filteredMarkets = useMemo(()=>{
        const data = markets || [];
        if (!searchQuery) return data;
        const q = searchQuery.toLowerCase();
        return data.filter(m => (m.ticker||'').toLowerCase().includes(q) || (m.title||'').toLowerCase().includes(q));
      }, [markets, searchQuery]);

      const statusChip = status === 'live' ? 'bg-green-600' : (status === 'connecting' ? 'bg-yellow-600' : 'bg-red-600');

      return (
        <div className="min-h-screen bg-gray-50">
          <header className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 shadow-lg">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold">Kalshi Market Tools</h1>
                <p className="text-blue-100 mt-1">Advanced analytics for event contract trading</p>
              </div>
              <span className={"px-3 py-1 rounded-full text-sm " + statusChip}>
                {status === 'live' ? 'Live data' : status === 'connecting' ? 'Connectingâ€¦' : 'Disconnected'}
              </span>
            </div>
          </header>

          <nav className="bg-white shadow-sm">
            <div className="flex space-x-8 px-6">
              <button onClick={()=>setActiveTab('technical')} 
                      className={"py-4 px-2 font-medium transition " + (activeTab==='technical'?'tab-active':'text-gray-600')}>
                Technical Analysis
              </button>
              <button onClick={()=>setActiveTab('disputes')} 
                      className={"py-4 px-2 font-medium transition " + (activeTab==='disputes'?'tab-active':'text-gray-600')}>
                Market Disputes
              </button>
              <button onClick={()=>setActiveTab('personal')} 
                      className={"py-4 px-2 font-medium transition flex items-center gap-2 " + (activeTab==='personal'?'tab-active':'text-gray-600')}>
                Personal Markets
                <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">Soon</span>
              </button>
            </div>
          </nav>

          <main className="container mx-auto px-6 py-6">
            {activeTab === 'technical' && (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <aside className="lg:sticky lg:top-4">
                  <div className="bg-white rounded-lg shadow p-4">
                    <h3 className="font-semibold text-lg mb-4">Markets</h3>
                    <input type="text" placeholder="Search markets..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)}
                           className="w-full px-3 py-2 border rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                    <div className="space-y-2 overflow-y-auto" style={{ maxHeight: '600px' }}>
                      {filteredMarkets.length ? filteredMarkets.map(m => (
                        <MarketCard key={m.ticker} market={m} isSelected={selectedMarket?.ticker===m.ticker} onClick={()=>setSelectedMarket(m)}/>
                      )) : (
                        <div className="p-4 rounded-lg border bg-gray-900 text-gray-200 skeleton">Loading marketsâ€¦</div>
                      )}
                    </div>
                    {error && <div className="text-xs text-red-600 mt-2">Error: {error}</div>}
                  </div>
                </aside>

                <div className="lg:col-span-2">
                  <TechnicalAnalysis market={selectedMarket} markets={filteredMarkets} />
                </div>
              </div>
            )}

            {activeTab === 'disputes' && <MarketDisputes />}
            {activeTab === 'personal' && <PersonalMarkets />}
          </main>

          <footer className="bg-gray-800 text-white mt-12 py-8">
            <div className="container mx-auto px-6">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                  <h4 className="font-semibold mb-3">Kalshi Market Tools</h4>
                  <p className="text-gray-400 text-sm">Professional analytics for event contract trading. Not affiliated with Kalshi Inc.</p>
                </div>
                <div>
                  <h4 className="font-semibold mb-3">Features</h4>
                  <ul className="text-gray-400 text-sm space-y-1">
                    <li>â€¢ Technical analysis suite</li>
                    <li>â€¢ Market dispute tracking</li>
                    <li>â€¢ Historical pattern analysis</li>
                    <li>â€¢ Personal markets (coming soon)</li>
                  </ul>
                </div>
                <div>
                  <h4 className="font-semibold mb-3">Status</h4>
                  <p className="text-gray-400 text-sm">
                    <span className={"inline-block w-2 h-2 rounded-full mr-2 " + (status==='live'?'bg-green-500':status==='connecting'?'bg-yellow-500':'bg-red-500')}></span>
                    {status==='live'?'Live Data':status==='connecting'?'Connectingâ€¦':'Disconnected'}
                  </p>
                  <p className="text-gray-400 text-sm mt-2">Charts: {window.Recharts ? 'ðŸ“Š Advanced' : 'ðŸ“ˆ Basic'}</p>
                </div>
              </div>
              <div className="mt-8 pt-8 border-t border-gray-700 text-center text-sm text-gray-400">
                <p>Â© 2025 Kalshi Market Tools â€¢ Data for demonstration purposes</p>
              </div>
            </div>
          </footer>
        </div>
      );
    }

    // Render
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => ReactDOM.render(<App />, document.getElementById('root')));
    } else {
      ReactDOM.render(<App />, document.getElementById('root'));
    }
  </script>
</body>
</html>
