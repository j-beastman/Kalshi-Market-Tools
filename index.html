<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kalshi Market Tools (Live)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/recharts@2.10.3/umd/Recharts.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
</head>
<body class="bg-slate-950 text-white">
  <div id="root" class="p-6 max-w-6xl mx-auto"></div>
  <script type="text/babel">
    const {useState, useEffect} = React;
    const RechartsLib = window.Recharts || {};
    const { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } = RechartsLib;

    const API_BASE = window.API_BASE || "REPLACE_WITH_RAILWAY_URL"; // e.g., https://my-app.up.railway.app

    function LibWarning(){
  return (
    <div className="bg-amber-900/40 border border-amber-700 rounded-xl p-3 text-sm mb-3">
      Recharts failed to load from the CDN. Charts are disabled, but the rest of the app should work.
    </div>
  );
}
function Chart({ticker}) {
      const [series, setSeries] = useState([]);
      useEffect(() => {
        if (!ticker) return;
        fetch(`${API_BASE}/markets/${ticker}`).then(r=>r.json()).then(d=>{
          setSeries(d.series || []);
        });
      }, [ticker]);
      return (
        <div className="bg-slate-900 rounded-2xl p-4 shadow">
          <div className="font-semibold mb-3">Price over time — {ticker}</div>
          {!LineChart ? <LibWarning/> : null}
          <div style={{width:"100%", height:300}}>
            {LineChart ? <ResponsiveContainer>
              <LineChart data={series}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="ts" tickFormatter={(t)=>new Date(t).toLocaleTimeString()} minTickGap={48}/>
                <YAxis/>
                <Tooltip />
                <Line type="monotone" dataKey="yes" dot={false} />
                <Line type="monotone" dataKey="no" dot={false} />
              </LineChart>
            </ResponsiveContainer> : null}
          </div>
        </div>
      );
    }

    function App(){
      const [markets, setMarkets] = useState([]);
      const [selected, setSelected] = useState(null);
      const [status, setStatus] = useState("connecting");

      // initial load
      useEffect(()=>{
        fetch(`${API_BASE}/markets`).then(r=>r.json()).then(d=>{
          setMarkets(d);
          setSelected(d[0]?.ticker || null);
        });
      }, []);

      // live updates via SSE
      useEffect(()=>{
        const es = new EventSource(`${API_BASE}/stream`);
        es.onopen = () => setStatus("live");
        es.onmessage = (ev) => {
          try {
            const payload = JSON.parse(ev.data);
            if (payload.type === "upsert") {
              // merge updates by ticker
              setMarkets(prev => {
                const byT = Object.fromEntries(prev.map(m => [m.ticker, m]));
                for (const u of payload.markets) {
                  byT[u.ticker] = {...(byT[u.ticker]||{}), ...u};
                }
                return Object.values(byT).sort((a,b)=>a.ticker.localeCompare(b.ticker));
              });
            }
          } catch {}
        };
        es.onerror = () => setStatus("disconnected");
        return () => es.close();
      }, []);

      return (
        <div className="space-y-6">
          <header className="flex items-center justify-between">
            <h1 className="text-2xl font-bold">Kalshi Market Tools</h1>
            <span className={"px-3 py-1 rounded-full text-sm " + (status==="live"?"bg-green-600":"bg-yellow-600")}>
              {status==="live"?"Live data":"Connecting…"}
            </span>
          </header>

          <section className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="bg-slate-900 rounded-2xl p-4 shadow">
              <div className="font-semibold mb-3">Markets</div>
              <div className="space-y-2">
                {markets.map(m => (
                  <button
                    key={m.ticker}
                    onClick={()=>setSelected(m.ticker)}
                    className={"w-full text-left p-3 rounded-xl border transition " + (selected===m.ticker ? "bg-slate-800 border-slate-700" : "bg-slate-900 border-slate-800 hover:bg-slate-800")}
                  >
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="font-medium">{m.title || m.ticker}</div>
                        <div className="text-xs text-slate-400">{m.ticker}</div>
                      </div>
                      <div className="text-right">
                        <div className="text-lg font-bold">{m.yes_price ?? 0}</div>
                        <div className="text-xs text-slate-400">YES • {m.volume_24h ?? 0} vol</div>
                      </div>
                    </div>
                  </button>
                ))}
                {markets.length===0 && <div className="text-slate-400">Loading…</div>}
              </div>
            </div>

            <div>
              {selected ? <Chart ticker={selected}/> : <div className="bg-slate-900 rounded-2xl p-4 shadow">Select a market</div>}
            </div>
          </section>

          <footer className="text-center text-slate-400 text-sm pt-4 border-t border-slate-800">
            © 2025 • Demo — replace the simulated puller with real Kalshi fetches on the backend.
          </footer>
        </div>
      );
    }

    ReactDOM.render(<App/>, document.getElementById('root'));
  </script>
</body>
</html>
