<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalshi Market Tools - Hedge Anything</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 17 + ReactDOM 17 -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.production.min.js?v=4"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.production.min.js?v=4"></script>

  <!-- PropTypes must come before Recharts -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js?v=4"></script>
  <!-- Recharts (UMD) -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/recharts@2.9.0/umd/Recharts.min.js?v=4"></script>

  <!-- Babel for JSX (dev) -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.7/babel.min.js?v=4"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
    .market-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .skeleton { background: linear-gradient(90deg, #111827 25%, #1f2937 50%, #111827 75%); background-size: 1000px 100%; animation: loading 2s infinite; }
    @keyframes loading { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
    .hedge-card { transition: all 0.3s ease; }
    .hedge-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root">Loading...</div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const RechartsLib = window.Recharts || {};
    const { LineChart, Line, BarChart, Bar, ComposedChart, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell } = RechartsLib;

    // --- CONFIG ---
    // Change this to your Railway URL, or append ?api=https://your-app.up.railway.app
    const params = new URLSearchParams(location.search);
    const API_BASE = params.get('api') || "https://kalshi-market-tools-production.up.railway.app";

    // --- UTIL ---
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const fallback = (v, d) => (v === undefined || v === null ? d : v);

    // --- SIMPLE FALLBACK CHART ---
    const SimpleChart = ({ data, title }) => {
      if (!data || data.length === 0) return null;
      const maxValue = Math.max(...data.map(d => d.value || 0), 1);
      return (
        <div className="bg-white rounded-lg shadow p-4">
          <h4 className="text-sm font-semibold mb-3">{title}</h4>
          <div className="space-y-2">
            {data.slice(0, 10).map((item, i) => (
              <div key={i} className="flex items-center">
                <span className="text-xs w-16">{item.label}</span>
                <div className="flex-1 mx-2">
                  <div className="h-4 bg-blue-500 rounded" style={{ width: `${(item.value / maxValue) * 100}%` }}></div>
                </div>
                <span className="text-xs">{item.value}</span>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // --- LIVE DATA STORE ---
    function useLiveMarkets(){
      const [markets, setMarkets] = useState([]);
      const [status, setStatus] = useState('connecting'); // connecting | live | disconnected
      const [error, setError] = useState(null);

      // initial fetch
      useEffect(()=>{
        fetch(`${API_BASE}/markets`)
          .then(async r => {
            if(!r.ok) throw new Error(`GET /markets ${r.status}`);
            return await r.json();
          })
          .then(data => setMarkets(Array.isArray(data) ? data : []))
          .catch(e => setError(String(e)));
      }, []);

      // SSE updates
      useEffect(()=>{
        const es = new EventSource(`${API_BASE}/stream`);
        es.onopen = () => setStatus('live');
        es.onmessage = (ev) => {
          try {
            const payload = JSON.parse(ev.data);
            if (payload.type === 'upsert' && Array.isArray(payload.markets)) {
              setMarkets(prev => {
                const byT = Object.fromEntries(prev.map(m => [m.ticker, m]));
                for (const u of payload.markets) {
                  if (u.ticker) byT[u.ticker] = { ...(byT[u.ticker]||{ ticker: u.ticker, title: u.ticker }), ...u };
                }
                return Object.values(byT).sort((a,b)=>a.ticker.localeCompare(b.ticker));
              });
            }
          } catch {}
        };
        es.onerror = () => setStatus('disconnected');
        return () => es.close();
      }, []);

      return { markets, setMarkets, status, error };
    }

    // --- MARKET CARD ---
    function MarketCard({ market, isSelected, onClick }) {
      const volatility = market.volatility ?? 6.0;
      const getVolatilityColor = (vol) => {
        if (vol > 8) return 'bg-red-100 text-red-600';
        if (vol > 6) return 'bg-yellow-100 text-yellow-600';
        return 'bg-green-100 text-green-600';
      };
      return (
        <div onClick={onClick}
             className={`market-card p-4 rounded-lg border-2 cursor-pointer transition-all ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}>
          <div className="flex justify-between items-start mb-2">
            <span className="font-mono text-sm text-gray-500">{market.ticker}</span>
            <span className={`text-xs px-2 py-1 rounded-full ${getVolatilityColor(volatility)}`}>
              œÉ{volatility}
            </span>
          </div>
          <h4 className="font-medium text-sm mb-2">{market.title || market.ticker}</h4>
          <div className="flex justify-between items-center text-xs text-gray-500">
            <span>{fallback(market.volume_24h, 0).toLocaleString()} vol</span>
            <span className="bg-gray-100 px-2 py-1 rounded">{market.category || 'General'}</span>
          </div>
        </div>
      );
    }

    // --- MARKET HEADER ---
    function MarketHeader({ market }) {
      if (!market) return null;
      const yes_price = fallback(market.yes_price, 0);
      const no_price  = fallback(market.no_price,  0);
      // derive soft bids/asks if backend doesn't provide them
      const yes_bid = fallback(market.yes_bid, Math.max(0, yes_price - 1));
      const yes_ask = fallback(market.yes_ask, Math.min(100, yes_price + 1));
      const no_bid  = fallback(market.no_bid,  Math.max(0, no_price  - 1));
      const no_ask  = fallback(market.no_ask,  Math.min(100, no_price + 1));
      const spreadPct = yes_price ? ((yes_ask - yes_bid) / yes_price * 100) : 0;

      return (
        <div className="bg-white rounded-lg shadow p-6 mb-6">
          <div className="mb-4">
            <p className="text-sm text-gray-500 font-mono">{market.ticker}</p>
            <h2 className="text-2xl font-bold">{market.title || market.ticker}</h2>
          </div>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <p className="text-xs text-gray-500">YES Price</p>
              <p className="text-2xl font-bold text-green-600">{yes_price}¬¢</p>
              <p className="text-xs text-gray-400">B: {yes_bid}¬¢ / A: {yes_ask}¬¢</p>
            </div>
            <div>
              <p className="text-xs text-gray-500">NO Price</p>
              <p className="text-2xl font-bold text-red-600">{no_price}¬¢</p>
              <p className="text-xs text-gray-400">B: {no_bid}¬¢ / A: {no_ask}¬¢</p>
            </div>
            <div>
              <p className="text-xs text-gray-500">Volume</p>
              <p className="text-xl font-semibold">{fallback(market.volume_24h, 0).toLocaleString()}</p>
            </div>
            <div>
              <p className="text-xs text-gray-500">Spread</p>
              <p className="text-xl font-semibold">{spreadPct.toFixed(1)}%</p>
            </div>
          </div>
        </div>
      );
    }

    // --- HEDGE ANYTHING COMPONENT ---
    function HedgeAnything({ markets }) {
      const [hedgeType, setHedgeType] = useState('mortgage');
      const [userProfile, setUserProfile] = useState({
        mortgage: {
          principal: 400000,
          rate: 7.0,
          yearsRemaining: 25,
          desiredRate: 5.5
        }
      });

      // Calculate mortgage hedging strategy
      const mortgageHedge = useMemo(() => {
        const { principal, rate, yearsRemaining, desiredRate } = userProfile.mortgage;
        const monthlyPayments = yearsRemaining * 12;
        
        // Calculate current monthly payment
        const monthlyRate = rate / 100 / 12;
        const currentMonthly = principal * (monthlyRate * Math.pow(1 + monthlyRate, monthlyPayments)) / 
                              (Math.pow(1 + monthlyRate, monthlyPayments) - 1);
        
        // Calculate potential monthly payment at desired rate
        const desiredMonthlyRate = desiredRate / 100 / 12;
        const desiredMonthly = principal * (desiredMonthlyRate * Math.pow(1 + desiredMonthlyRate, monthlyPayments)) / 
                              (Math.pow(1 + desiredMonthlyRate, monthlyPayments) - 1);
        
        // Calculate total savings if rates drop
        const monthlySavings = currentMonthly - desiredMonthly;
        const totalSavings = monthlySavings * monthlyPayments;
        
        // Assume each 25bps rate cut reduces mortgage rates by ~20bps
        const bpsDifference = (rate - desiredRate) * 100; // Convert to basis points
        const requiredCuts = Math.ceil(bpsDifference / 20); // How many 25bp cuts needed
        
        return {
          currentMonthly: currentMonthly.toFixed(2),
          desiredMonthly: desiredMonthly.toFixed(2),
          monthlySavings: monthlySavings.toFixed(2),
          totalSavings: totalSavings.toFixed(0),
          requiredCuts,
          bpsDifference: bpsDifference.toFixed(0)
        };
      }, [userProfile.mortgage]);

      // Find relevant Fed rate markets
      const fedMarkets = useMemo(() => {
        if (!markets || markets.length === 0) return [];
        
        // Filter for Fed/rate related markets
        const relevantMarkets = markets.filter(m => {
          const title = (m.title || m.ticker || '').toLowerCase();
          const ticker = (m.ticker || '').toLowerCase();
          return title.includes('fed') || title.includes('rate') || 
                 ticker.includes('fed') || ticker.includes('rate') ||
                 title.includes('fomc') || ticker.includes('fomc') ||
                 title.includes('interest') || ticker.includes('interest');
        });
        
        return relevantMarkets.slice(0, 5);
      }, [markets]);

      // Calculate hedge amounts
      const hedgeCalculations = useMemo(() => {
        return fedMarkets.map(market => {
          const noPrice = fallback(market.no_price, 50);
          
          // If rates don't drop, you want to recover some of your lost savings
          // Betting on NO (rates don't drop) at current price
          // If you bet $X at NO price of Y cents, you get $X * (100/Y) if NO wins
          
          // Let's hedge 1 year of potential savings
          const yearlyLostSavings = mortgageHedge.monthlySavings * 12;
          
          // Calculate how much to bet to recover yearly savings if NO wins
          const hedgeAmount = (yearlyLostSavings * noPrice) / 100;
          const potentialPayout = hedgeAmount * (100 / noPrice);
          const netProfit = potentialPayout - hedgeAmount;
          
          return {
            market,
            hedgeAmount: hedgeAmount.toFixed(2),
            potentialPayout: potentialPayout.toFixed(2),
            netProfit: netProfit.toFixed(2),
            returnMultiple: (100 / noPrice).toFixed(2)
          };
        });
      }, [fedMarkets, mortgageHedge]);

      return (
        <div>
          {/* Header Section */}
          <div className="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg p-8 mb-6">
            <h2 className="text-3xl font-bold mb-4">Hedge Anything</h2>
            <p className="text-lg mb-4 text-purple-100">
              Turn life's uncertainties into opportunities. Use prediction markets to protect against financial risks.
            </p>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
              <button onClick={() => setHedgeType('mortgage')} 
                      className={`p-3 rounded-lg font-medium transition ${hedgeType==='mortgage' ? 'bg-white text-purple-600' : 'bg-purple-500/20 hover:bg-purple-500/30'}`}>
                üè† Mortgage Rates
              </button>
              <button className="p-3 rounded-lg bg-purple-500/20 hover:bg-purple-500/30 font-medium opacity-50 cursor-not-allowed">
                ‚òÅÔ∏è Weather (Coming Soon)
              </button>
              <button className="p-3 rounded-lg bg-purple-500/20 hover:bg-purple-500/30 font-medium opacity-50 cursor-not-allowed">
                üèÜ Sports (Coming Soon)
              </button>
              <button className="p-3 rounded-lg bg-purple-500/20 hover:bg-purple-500/30 font-medium opacity-50 cursor-not-allowed">
                üõí Inflation (Coming Soon)
              </button>
            </div>
          </div>

          {hedgeType === 'mortgage' && (
            <>
              {/* Mortgage Input Form */}
              <div className="bg-white rounded-lg shadow p-6 mb-6">
                <h3 className="text-xl font-bold mb-4">Your Mortgage Details</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Remaining Principal Balance
                    </label>
                    <div className="relative">
                      <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                      <input 
                        type="number" 
                        value={userProfile.mortgage.principal}
                        onChange={e => setUserProfile(prev => ({
                          ...prev, 
                          mortgage: {...prev.mortgage, principal: parseInt(e.target.value) || 0}
                        }))}
                        className="w-full pl-8 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Current Interest Rate (%)
                    </label>
                    <input 
                      type="number" 
                      step="0.1"
                      value={userProfile.mortgage.rate}
                      onChange={e => setUserProfile(prev => ({
                        ...prev, 
                        mortgage: {...prev.mortgage, rate: parseFloat(e.target.value) || 0}
                      }))}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Years Remaining
                    </label>
                    <input 
                      type="number" 
                      value={userProfile.mortgage.yearsRemaining}
                      onChange={e => setUserProfile(prev => ({
                        ...prev, 
                        mortgage: {...prev.mortgage, yearsRemaining: parseInt(e.target.value) || 0}
                      }))}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Target Refinance Rate (%)
                    </label>
                    <input 
                      type="number" 
                      step="0.1"
                      value={userProfile.mortgage.desiredRate}
                      onChange={e => setUserProfile(prev => ({
                        ...prev, 
                        mortgage: {...prev.mortgage, desiredRate: parseFloat(e.target.value) || 0}
                      }))}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </div>
              </div>

              {/* Analysis Results */}
              <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                <h3 className="text-xl font-bold mb-4 text-blue-900">Your Refinancing Analysis</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-white rounded-lg p-4">
                    <p className="text-sm text-gray-600">Current Monthly</p>
                    <p className="text-2xl font-bold">${mortgageHedge.currentMonthly}</p>
                  </div>
                  <div className="bg-white rounded-lg p-4">
                    <p className="text-sm text-gray-600">Target Monthly</p>
                    <p className="text-2xl font-bold text-green-600">${mortgageHedge.desiredMonthly}</p>
                  </div>
                  <div className="bg-white rounded-lg p-4">
                    <p className="text-sm text-gray-600">Monthly Savings</p>
                    <p className="text-2xl font-bold text-blue-600">${mortgageHedge.monthlySavings}</p>
                  </div>
                  <div className="bg-white rounded-lg p-4">
                    <p className="text-sm text-gray-600">Lifetime Savings</p>
                    <p className="text-2xl font-bold text-purple-600">${parseInt(mortgageHedge.totalSavings).toLocaleString()}</p>
                  </div>
                </div>
                <div className="mt-4 p-4 bg-yellow-50 rounded-lg">
                  <p className="text-sm text-yellow-800">
                    <strong>Analysis:</strong> You need approximately {mortgageHedge.requiredCuts} rate cuts of 25 basis points each 
                    to reach your target refinancing rate. That's a total of {mortgageHedge.bpsDifference} basis points.
                  </p>
                </div>
              </div>

              {/* Hedging Recommendations */}
              <div className="bg-white rounded-lg shadow p-6">
                <h3 className="text-xl font-bold mb-4">üìä Recommended Hedging Markets</h3>
                <p className="text-gray-600 mb-6">
                  If rates don't drop as expected, these bets can help offset your lost savings opportunity. 
                  We recommend hedging 1 year of potential savings to start.
                </p>
                
                {hedgeCalculations.length > 0 ? (
                  <div className="space-y-4">
                    {hedgeCalculations.map((calc, idx) => (
                      <div key={idx} className="hedge-card border rounded-lg p-4 hover:bg-gray-50">
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex-1">
                            <h4 className="font-semibold text-lg">{calc.market.title || calc.market.ticker}</h4>
                            <p className="text-sm text-gray-500 font-mono">{calc.market.ticker}</p>
                          </div>
                          <div className="text-right">
                            <span className="text-sm text-gray-500">NO Price</span>
                            <p className="text-xl font-bold text-red-600">{fallback(calc.market.no_price, 50)}¬¢</p>
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-3 gap-4 p-3 bg-gray-50 rounded">
                          <div>
                            <p className="text-xs text-gray-600">Hedge Amount</p>
                            <p className="font-bold text-blue-600">${calc.hedgeAmount}</p>
                            <p className="text-xs text-gray-500">Bet on NO</p>
                          </div>
                          <div>
                            <p className="text-xs text-gray-600">If Rates Don't Drop</p>
                            <p className="font-bold text-green-600">${calc.potentialPayout}</p>
                            <p className="text-xs text-gray-500">{calc.returnMultiple}x return</p>
                          </div>
                          <div>
                            <p className="text-xs text-gray-600">Net Profit</p>
                            <p className="font-bold">${calc.netProfit}</p>
                            <p className="text-xs text-gray-500">Offsets lost savings</p>
                          </div>
                        </div>
                        
                        <div className="mt-3 flex justify-between items-center">
                          <span className="text-sm text-gray-600">
                            Volume: {fallback(calc.market.volume_24h, 0).toLocaleString()}
                          </span>
                          <button className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            Place Hedge on Kalshi ‚Üí
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <p className="text-xl mb-4">No Fed rate markets currently available</p>
                    <p className="text-sm">Check back when FOMC meeting markets are active</p>
                  </div>
                )}
                
                <div className="mt-6 p-4 bg-gray-100 rounded-lg">
                  <p className="text-xs text-gray-600">
                    <strong>Disclaimer:</strong> This is not financial advice. Hedging strategies involve risk and may result in losses. 
                    Mortgage rates are influenced by many factors beyond Fed policy. Please consult with a financial advisor.
                  </p>
                </div>
              </div>
            </>
          )}
        </div>
      );
    }

    // --- IMPACT CALCULATOR ---
    function ImpactCalculator({ market }) {
      const [side, setSide] = useState('yes');
      const [quantity, setQuantity] = useState(100);
      const [impact, setImpact] = useState(null);

      const generateImpact = (quantity, side, market) => {
        const base = side === 'yes' ? fallback(market.yes_price, 0) : fallback(market.no_price, 0);
        const levels = [];
        let remaining = quantity, totalCost = 0, totalFilled = 0;
        for (let i=0; i<5 && remaining>0; i++){
          const levelPx = base + i*0.5;
          const levelQty = i===0 ? 200 : 300;
          const fill = Math.min(remaining, levelQty);
          const rem  = levelQty - fill;
          if (fill>0){
            levels.push({ price: levelPx, filled: fill, remaining: rem });
            totalCost += fill * levelPx;
            totalFilled += fill;
            remaining -= fill;
          }
        }
        const avgPrice = totalFilled ? totalCost/totalFilled : base;
        const slippage = base ? ((avgPrice - base)/base*100) : 0;
        const fillRate = totalFilled/quantity*100;
        return { avg_price: avgPrice, total_cost: totalCost/100, slippage, fill_rate: fillRate, levels_consumed: levels };
      };

      useEffect(() => { if (market) setImpact(generateImpact(quantity, side, market)); }, [market, quantity, side]);

      const chartData = useMemo(() => {
        if (!market) return [];
        const base = side === 'yes' ? fallback(market.yes_price, 0) : fallback(market.no_price, 0);
        const pts = [];
        for (let q=10; q<=2000; q+=100){
          const imp = generateImpact(q, side, market);
          pts.push({ quantity: q, marketPrice: base, executionPrice: imp.avg_price, slippage: imp.slippage });
        }
        return pts;
      }, [market, side]);

      if (!market) return <div className="text-center py-12 text-gray-500"><p className="text-xl">Select a market to calculate order impact</p></div>;

      return (
        <div>
          <MarketHeader market={market} />
          <div className="bg-white rounded-lg shadow p-6 mb-6">
            <h3 className="text-lg font-semibold mb-4">Order Configuration</h3>
            <div className="space-y-4">
              <div>
                <label className="text-sm font-medium text-gray-700">Side</label>
                <div className="flex gap-2 mt-1">
                  <button onClick={() => setSide('yes')} className={`flex-1 py-2 rounded-lg font-medium transition ${side==='yes'?'bg-green-500 text-white':'bg-gray-100'}`}>YES</button>
                  <button onClick={() => setSide('no')}  className={`flex-1 py-2 rounded-lg font-medium transition ${side==='no'?'bg-red-500 text-white':'bg-gray-100'}`}>NO</button>
                </div>
              </div>
              <div>
                <label className="text-sm font-medium text-gray-700">Order Size: {quantity} contracts</label>
                <input type="range" min="10" max="2000" step="10" value={quantity} onChange={e=>setQuantity(parseInt(e.target.value))} className="w-full mt-2"/>
              </div>
            </div>
          </div>

          {impact && (
            <>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div className="bg-blue-50 p-4 rounded-lg"><p className="text-sm text-gray-600">Avg Price</p><p className="text-2xl font-bold text-blue-600">{impact.avg_price.toFixed(1)}¬¢</p></div>
                <div className="bg-purple-50 p-4 rounded-lg"><p className="text-sm text-gray-600">Total Cost</p><p className="text-2xl font-bold text-purple-600">${impact.total_cost.toFixed(2)}</p></div>
                <div className="bg-orange-50 p-4 rounded-lg"><p className="text-sm text-gray-600">Slippage</p><p className="text-2xl font-bold text-orange-600">{impact.slippage.toFixed(1)}%</p></div>
                <div className="bg-green-50 p-4 rounded-lg"><p className="text-sm text-gray-600">Fill Rate</p><p className="text-2xl font-bold text-green-600">{impact.fill_rate.toFixed(0)}%</p></div>
              </div>

              {window.Recharts ? (
                <div className="bg-white rounded-lg shadow p-6">
                  <h3 className="text-lg font-semibold mb-2">Price Impact Visualization</h3>
                  <ResponsiveContainer width="100%" height={350}>
                    <ComposedChart data={chartData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                      <XAxis dataKey="quantity" label={{ value: 'Order Size (contracts)', position: 'insideBottom', offset: -5 }} stroke="#6b7280"/>
                      <YAxis label={{ value: 'Price (¬¢)', angle: -90, position: 'insideLeft' }} stroke="#6b7280" domain={['dataMin - 2', 'dataMax + 2']}/>
                      <Tooltip /><Legend />
                      <Area type="monotone" dataKey="executionPrice" fill="#3b82f633" stroke="none"/>
                      <Line type="monotone" dataKey="marketPrice" stroke="#9ca3af" strokeDasharray="5 5" name="Market Price" strokeWidth={2} dot={false}/>
                      <Line type="monotone" dataKey="executionPrice" stroke="#3b82f6" name="Your Execution Price" strokeWidth={3} dot={{ r: 3 }}/>
                    </ComposedChart>
                  </ResponsiveContainer>
                </div>
              ) : (
                <SimpleChart data={chartData.map(d => ({ label: `${d.quantity}`, value: d.executionPrice }))} title="Price Impact by Order Size"/>
              )}
            </>
          )}
        </div>
      );
    }

    // --- VOLUME VELOCITY ---
    function VolumeVelocity({ market }){
      const [data, setData] = useState(null);
      useEffect(()=>{
        if (!market) return;
        const baseVol = fallback(market.volume_24h, 0);
        const yes = fallback(market.yes_price, 50);
        setData({
          metrics: {
            total_volume: baseVol * 24,
            recent_avg: Math.floor(baseVol * 1.3),
            earlier_avg: Math.floor(baseVol * 0.9),
            velocity_change: 44.4
          },
          peak: { hour: '14:00', volume: Math.floor(baseVol * 2.5), coincided_with_news: Math.random()>0.5 },
          news_events: Math.random()>0.5 ? [{ timestamp: new Date().toISOString(), description: 'Fed announces surprise rate decision', volume_spike: baseVol*2, price_at_event: yes }] : []
        });
      }, [market]);

      const hourlyData = useMemo(()=>{
        if (!data || !market) return [];
        const y = fallback(market.yes_price, 50);
        const hours = [];
        for (let i=0;i<24;i++){
          hours.push({ hour: `${i}:00`, volume: Math.floor(Math.random()*1000+100), price: y + (Math.random()-0.5)*10 });
        }
        hours[14] = { hour: '14:00', volume: 2500, price: y + 3 };
        return hours;
      }, [data, market]);

      if (!market) return <div className="text-center py-12 text-gray-500"><p className="text-xl">Select a market to analyze volume velocity</p></div>;
      if (!data) return null;

      return (
        <div>
          <MarketHeader market={market} />
          {window.Recharts ? (
            <div className="bg-white rounded-lg shadow p-6 mb-6">
              <h3 className="text-lg font-semibold mb-4">Volume & Price Over Time (24h)</h3>
              <ResponsiveContainer width="100%" height={300}>
                <ComposedChart data={hourlyData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
                  <XAxis dataKey="hour" />
                  <YAxis yAxisId="volume" orientation="left" />
                  <YAxis yAxisId="price" orientation="right" />
                  <Tooltip /><Legend />
                  <Bar yAxisId="volume" dataKey="volume" fill="#3b82f6" opacity={0.7} name="Volume"/>
                  <Line yAxisId="price" type="monotone" dataKey="price" stroke="#10b981" strokeWidth={3} name="Price (¬¢)" dot={{ r:2 }}/>
                </ComposedChart>
              </ResponsiveContainer>
            </div>
          ) : (
            <SimpleChart data={hourlyData.map(d => ({ label: d.hour, value: d.volume }))} title="Volume Over Time (24h)"/>
          )}
        </div>
      );
    }

    // --- COMPARISON ---
    function Comparison({ markets }) {
      const [selected, setSelected] = useState([]);
      const toggle = (m) => {
        setSelected(prev => prev.find(x=>x.ticker===m.ticker) ? prev.filter(x=>x.ticker!==m.ticker) : (prev.length<4?[...prev,m]:prev));
      };
      const comparisonData = useMemo(()=>{
        return selected.map(m => ({
          ticker: m.ticker,
          price: fallback(m.yes_price, 0),
          volume: Math.round(fallback(m.volume_24h, 0)/100),
          volatility: 70,
          spread: 10
        }));
      }, [selected]);

      return (
        <div>
          <div className="bg-white rounded-lg shadow p-6 mb-6">
            <h3 className="text-lg font-semibold mb-4">Select Markets to Compare (Max 4)</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              {markets.map(m => (
                <button key={m.ticker} onClick={()=>toggle(m)}
                        className={`p-3 rounded-lg border-2 transition ${selected.find(x=>x.ticker===m.ticker)?'border-blue-500 bg-blue-50':'border-gray-200 hover:border-gray-300'}`}>
                  <p className="font-mono text-xs">{m.ticker}</p>
                  <p className="text-sm">{(m.title||m.ticker).substring(0,40)}...</p>
                </button>
              ))}
            </div>
          </div>

          {selected.length>1 && (
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-semibold mb-4">Visual Comparison</h3>
              {window.Recharts ? (
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={comparisonData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
                    <XAxis dataKey="ticker" /><YAxis /><Tooltip /><Legend />
                    <Bar dataKey="price" fill="#10b981" name="Price (¬¢)" />
                    <Bar dataKey="volume" fill="#3b82f6" name="Volume (√∑100)" />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="grid grid-cols-2 gap-4">
                  <SimpleChart data={comparisonData.map(d=>({label:d.ticker, value:d.price}))} title="Price Comparison (¬¢)"/>
                  <SimpleChart data={comparisonData.map(d=>({label:d.ticker, value:d.volume}))} title="Volume Comparison (√∑100)"/>
                </div>
              )}
            </div>
          )}

          {selected.length===0 && <div className="text-center py-12 text-gray-400"><p className="text-lg">Select at least 2 markets to compare</p></div>}
          {selected.length===1 && <div className="text-center py-12 text-gray-400"><p className="text-lg">Select one more market to start comparison</p></div>}
        </div>
      );
    }

    // --- APP ---
    function App(){
      const [activeTab, setActiveTab] = useState('hedge');
      const { markets, status, error } = useLiveMarkets();
      const [selectedMarket, setSelectedMarket] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');

      useEffect(()=>{
        if (!markets.length) return;
        if (!selectedMarket) setSelectedMarket(markets[0]);
        else {
          const found = markets.find(m => m.ticker === selectedMarket.ticker);
          if (found) setSelectedMarket(found);
        }
      }, [markets]);

      const filteredMarkets = useMemo(()=>{
        const data = markets || [];
        if (!searchQuery) return data;
        const q = searchQuery.toLowerCase();
        return data.filter(m => (m.ticker||'').toLowerCase().includes(q) || (m.title||'').toLowerCase().includes(q));
      }, [markets, searchQuery]);

      const statusChip = status === 'live' ? 'bg-green-600' : (status === 'connecting' ? 'bg-yellow-600' : 'bg-red-600');

      return (
        <div className="min-h-screen bg-gray-50">
          <header className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 shadow-lg">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold">Kalshi Market Tools</h1>
                <p className="text-blue-100 mt-1">Advanced analytics & hedging for event contract trading</p>
              </div>
              <span className={"px-3 py-1 rounded-full text-sm " + statusChip}>
                {status === 'live' ? 'Live data' : status === 'connecting' ? 'Connecting‚Ä¶' : 'Disconnected'}
              </span>
            </div>
          </header>

          <nav className="bg-white shadow-sm">
            <div className="flex space-x-8 px-6 overflow-x-auto">
              <button onClick={()=>setActiveTab('hedge')} className={"py-4 px-2 font-medium transition whitespace-nowrap " + (activeTab==='hedge'?'tab-active':'text-gray-600')}>üõ°Ô∏è Hedge Anything</button>
              <button onClick={()=>setActiveTab('impact')} className={"py-4 px-2 font-medium transition whitespace-nowrap " + (activeTab==='impact'?'tab-active':'text-gray-600')}>üìä Market Impact</button>
              <button onClick={()=>setActiveTab('velocity')} className={"py-4 px-2 font-medium transition whitespace-nowrap " + (activeTab==='velocity'?'tab-active':'text-gray-600')}>üöÄ Volume Velocity</button>
              <button onClick={()=>setActiveTab('comparison')} className={"py-4 px-2 font-medium transition whitespace-nowrap " + (activeTab==='comparison'?'tab-active':'text-gray-600')}>üîÑ Multi-Market</button>
            </div>
          </nav>

          <main className="container mx-auto px-6 py-6">
            {activeTab === 'hedge' ? (
              <HedgeAnything markets={markets} />
            ) : (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <aside className="lg:sticky lg:top-4">
                  <div className="bg-white rounded-lg shadow p-4">
                    <h3 className="font-semibold text-lg mb-4">Markets</h3>
                    <input type="text" placeholder="Search markets..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)}
                           className="w-full px-3 py-2 border rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                    <div className="space-y-2 overflow-y-auto" style={{ maxHeight: '600px' }}>
                      {filteredMarkets.length ? filteredMarkets.map(m => (
                        <MarketCard key={m.ticker} market={m} isSelected={selectedMarket?.ticker===m.ticker} onClick={()=>setSelectedMarket(m)}/>
                      )) : (
                        <div className="p-4 rounded-lg border bg-gray-900 text-gray-200 skeleton">Loading markets‚Ä¶</div>
                      )}
                    </div>
                    {error && <div className="text-xs text-red-600 mt-2">Error: {error}</div>}
                  </div>
                </aside>

                <div className="lg:col-span-2">
                  {activeTab === 'impact'    && <ImpactCalculator market={selectedMarket} />}
                  {activeTab === 'velocity'  && <VolumeVelocity   market={selectedMarket} />}
                  {activeTab === 'comparison'&& <Comparison      markets={filteredMarkets} />}
                </div>
              </div>
            )}
          </main>

          <footer className="bg-gray-800 text-white mt-12 py-8">
            <div className="container mx-auto px-6">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                  <h4 className="font-semibold mb-3">Kalshi Market Tools</h4>
                  <p className="text-gray-400 text-sm">Professional analytics & hedging strategies for event contract trading. Not affiliated with Kalshi Inc.</p>
                </div>
                <div>
                  <h4 className="font-semibold mb-3">Features</h4>
                  <ul className="text-gray-400 text-sm space-y-1">
                    <li>‚Ä¢ Hedge against life's uncertainties</li>
                    <li>‚Ä¢ Order impact calculator</li>
                    <li>‚Ä¢ Volume velocity tracking</li>
                    <li>‚Ä¢ News event correlation</li>
                    <li>‚Ä¢ Multi-market comparison</li>
                  </ul>
                </div>
                <div>
                  <h4 className="font-semibold mb-3">Status</h4>
                  <p className="text-gray-400 text-sm">
                    <span className={"inline-block w-2 h-2 rounded-full mr-2 " + (status==='live'?'bg-green-500':status==='connecting'?'bg-yellow-500':'bg-red-500')}></span>
                    {status==='live'?'Live Data':status==='connecting'?'Connecting‚Ä¶':'Disconnected'}
                  </p>
                  <p className="text-gray-400 text-sm mt-2">Charts: {window.Recharts ? 'üìä Advanced Charts' : 'üìà Basic Charts'}</p>
                </div>
              </div>
              <div className="mt-8 pt-8 border-t border-gray-700 text-center text-sm text-gray-400">
                <p>¬© 2025 Kalshi Market Tools ‚Ä¢ For demonstration purposes ‚Ä¢ Not financial advice</p>
              </div>
            </div>
          </footer>
        </div>
      );
    }

    // Render
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => ReactDOM.render(<App />, document.getElementById('root')));
    } else {
      ReactDOM.render(<App />, document.getElementById('root'));
    }
  </script>
</body>
</html>