<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalshi Mortgage Hedge Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    .highlight { background: linear-gradient(120deg, #fbbf24 0%, #f59e0b 100%); padding: 2px 6px; border-radius: 4px; color: white; font-weight: 600; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:8000'
      : 'https://kalshi-market-tools-production.up.railway.app';

    const KALSHI_FEE = 0.07;

    function MortgageHedgeCalculator() {
      // Inputs
      const [loanAmount, setLoanAmount] = useState(500000);
      const [currentRate, setCurrentRate] = useState(7.5);
      const [refinanceThreshold, setRefinanceThreshold] = useState(6.5);
      const [refinanceCost, setRefinanceCost] = useState(5000);
      const [strategyType, setStrategyType] = useState('probability-weighted');
      
      // Market data
      const [fedMarkets, setFedMarkets] = useState([]);
      const [connectionStatus, setConnectionStatus] = useState('connecting');
      const [lastUpdate, setLastUpdate] = useState(null);
      
      // Results
      const [hedgeData, setHedgeData] = useState(null);
      const [showResults, setShowResults] = useState(false);
      const [calculating, setCalculating] = useState(false);

      // Calculated values
      const monthlyPayment = useMemo(() => {
        const r = currentRate / 100 / 12;
        const n = 30 * 12;
        return loanAmount * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
      }, [loanAmount, currentRate]);

      const yearlyOpportunityCost = useMemo(() => {
        const r2 = refinanceThreshold / 100 / 12;
        const n = 30 * 12;
        const refiPayment = loanAmount * (r2 * Math.pow(1 + r2, n)) / (Math.pow(1 + r2, n) - 1);
        return (monthlyPayment - refiPayment) * 12;
      }, [loanAmount, currentRate, refinanceThreshold, monthlyPayment]);

      const cutsToRefinance = useMemo(() => 
        Math.ceil((currentRate - refinanceThreshold) / 0.25),
        [currentRate, refinanceThreshold]
      );

      const optimalHedgeAmount = useMemo(() => 
        Math.round(yearlyOpportunityCost * 1.1),
        [yearlyOpportunityCost]
      );

      // Fetch Fed markets
      useEffect(() => {
        const fetchMarkets = async () => {
          try {
            const response = await fetch(`${API_BASE}/api/fed-markets`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            setFedMarkets(data);
            setConnectionStatus('connected');
            setLastUpdate(new Date());
          } catch (error) {
            console.error('Failed to fetch markets:', error);
            setConnectionStatus('error');
          }
        };

        fetchMarkets();
        const interval = setInterval(fetchMarkets, 30000);
        return () => clearInterval(interval);
      }, []);

      // SSE for real-time updates
      useEffect(() => {
        const eventSource = new EventSource(`${API_BASE}/stream`);
        
        eventSource.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'fed-update' && data.markets) {
              setFedMarkets(data.markets);
              setLastUpdate(new Date());
              setConnectionStatus('connected');
            }
          } catch (error) {
            console.error('SSE error:', error);
          }
        };

        eventSource.onerror = () => setConnectionStatus('error');
        return () => eventSource.close();
      }, []);

      // Calculate hedge
      const calculateHedge = async () => {
        setCalculating(true);
        
        try {
          const response = await fetch(`${API_BASE}/api/calculate-hedge`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              loan_amount: loanAmount,
              current_rate: currentRate,
              refinance_threshold: refinanceThreshold,
              refinance_cost: refinanceCost,
              strategy_type: strategyType
            })
          });

          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          
          const data = await response.json();
          setHedgeData(data);
          setShowResults(true);
        } catch (error) {
          console.error('Failed to calculate hedge:', error);
          // Fallback client-side calculation
          calculateClientSide();
        } finally {
          setCalculating(false);
        }
      };

      // Client-side calculation fallback
      const calculateClientSide = () => {
        if (fedMarkets.length === 0) {
          setFedMarkets([
            { cuts: 0, probability: 0.15, price: 15, ticker: 'FALLBACK-0', yes_bid: 14, yes_ask: 16 },
            { cuts: 1, probability: 0.25, price: 25, ticker: 'FALLBACK-1', yes_bid: 24, yes_ask: 26 },
            { cuts: 2, probability: 0.35, price: 35, ticker: 'FALLBACK-2', yes_bid: 34, yes_ask: 36 },
            { cuts: 3, probability: 0.20, price: 20, ticker: 'FALLBACK-3', yes_bid: 19, yes_ask: 21 },
            { cuts: 4, probability: 0.05, price: 5, ticker: 'FALLBACK-4', yes_bid: 4, yes_ask: 6 },
          ]);
        }

        const eligible = fedMarkets.filter(m => m.cuts < cutsToRefinance);
        const totalProb = eligible.reduce((sum, m) => sum + m.probability, 0);
        
        const allocations = eligible.map(market => {
          const weight = strategyType === 'probability-weighted' 
            ? market.probability / totalProb
            : 1.0 / eligible.length;
          
          const allocation = optimalHedgeAmount * weight;
          const contracts = Math.floor(allocation / (market.price / 100));
          const cost = contracts * (market.price / 100);
          const fees = contracts * KALSHI_FEE;
          const netProfit = contracts - cost - fees;
          
          return {
            cuts: market.cuts,
            probability: market.probability,
            price: market.price,
            ticker: market.ticker,
            allocation,
            contracts,
            cost,
            fees,
            payout: contracts,
            netProfit,
            kalshiUrl: `https://kalshi.com/markets/${market.ticker}`
          };
        });

        setHedgeData({
          yearly_opportunity_cost: yearlyOpportunityCost,
          optimal_hedge_amount: optimalHedgeAmount,
          cuts_to_refinance: cutsToRefinance,
          allocations,
          total_hedge_cost: allocations.reduce((sum, a) => sum + a.cost + a.fees, 0),
          expected_value: allocations.reduce((sum, a) => sum + a.probability * a.netProfit, 0)
        });
        setShowResults(true);
      };

      // Calculate scenario outcomes
      const scenarios = useMemo(() => {
        if (!hedgeData) return null;

        const outcomes = fedMarkets.map(market => {
          const isRefi = market.cuts >= cutsToRefinance;
          const allocation = hedgeData.allocations.find(a => a.cuts === market.cuts);
          
          return {
            cuts: market.cuts,
            probability: market.probability,
            rateAfterCuts: currentRate - (market.cuts * 0.25),
            hedgeResult: isRefi ? -hedgeData.total_hedge_cost : (allocation?.netProfit || 0),
            refiSavings: isRefi ? yearlyOpportunityCost - refinanceCost/5 : 0,
            netOutcome: isRefi 
              ? yearlyOpportunityCost - refinanceCost/5 - hedgeData.total_hedge_cost
              : (allocation?.netProfit || 0),
            isRefi
          };
        });

        const noRefiExpected = outcomes.filter(o => !o.isRefi).reduce((sum, o) => sum + o.probability * o.netOutcome, 0);
        const refiExpected = outcomes.filter(o => o.isRefi).reduce((sum, o) => sum + o.probability * o.netOutcome, 0);

        return {
          outcomes,
          noRefiExpected,
          refiExpected,
          totalExpected: noRefiExpected + refiExpected
        };
      }, [hedgeData, fedMarkets, cutsToRefinance, yearlyOpportunityCost, refinanceCost, currentRate]);

      const fmt = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
          {/* Header */}
          <header className="bg-white border-b border-gray-200">
            <div className="max-w-7xl mx-auto px-4 py-6">
              <div className="flex justify-between items-center">
                <div>
                  <h1 className="text-3xl font-bold text-gray-900">Kalshi Mortgage Rate Hedge</h1>
                  <p className="mt-2 text-gray-600">Protect against rates staying high with Fed rate prediction markets</p>
                </div>
                <div className="flex items-center space-x-4">
                  <div className={`flex items-center px-3 py-1 rounded-full text-sm ${
                    connectionStatus === 'connected' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                  }`}>
                    <div className={`w-2 h-2 rounded-full mr-2 ${
                      connectionStatus === 'connected' ? 'bg-green-500' : 'bg-red-500'
                    }`}></div>
                    {connectionStatus === 'connected' ? 'Live Data' : 'Connection Error'}
                  </div>
                  {lastUpdate && (
                    <div className="text-xs text-gray-500">
                      Updated: {lastUpdate.toLocaleTimeString()}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </header>

          {/* Main Content */}
          <div className="max-w-7xl mx-auto px-4 py-8">
            {/* Input Form */}
            <div className="bg-white rounded-xl shadow-lg p-8">
              <h2 className="text-2xl font-semibold mb-6">Your Mortgage Details</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Loan Amount</label>
                  <div className="relative">
                    <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                    <input type="number" value={loanAmount} onChange={(e) => setLoanAmount(Number(e.target.value))}
                      className="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Current Rate (%)</label>
                  <input type="number" step="0.1" value={currentRate} onChange={(e) => setCurrentRate(Number(e.target.value))}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Refinance If Rate Drops To (%)</label>
                  <input type="number" step="0.1" value={refinanceThreshold} onChange={(e) => setRefinanceThreshold(Number(e.target.value))}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Refinance Cost</label>
                  <div className="relative">
                    <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                    <input type="number" value={refinanceCost} onChange={(e) => setRefinanceCost(Number(e.target.value))}
                      className="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                  </div>
                </div>

                <div className="bg-blue-50 p-4 rounded-lg">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Current Monthly Payment</label>
                  <div className="text-2xl font-bold text-gray-900">{fmt(monthlyPayment)}</div>
                </div>

                <div className="bg-green-50 p-4 rounded-lg">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Monthly Savings if Refinanced</label>
                  <div className="text-2xl font-bold text-green-600">{fmt(yearlyOpportunityCost / 12)}</div>
                </div>
              </div>

              {/* Strategy Selector */}
              <div className="mt-6">
                <label className="block text-sm font-medium text-gray-700 mb-3">Hedging Strategy</label>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {['probability-weighted', 'max-protection', 'equal'].map(strategy => (
                    <button key={strategy} onClick={() => setStrategyType(strategy)}
                      className={`p-4 rounded-lg border-2 transition ${
                        strategyType === strategy ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'
                      }`}>
                      <h4 className="font-semibold">
                        {strategy === 'probability-weighted' ? 'Probability-Weighted' :
                         strategy === 'max-protection' ? 'Maximum Protection' : 'Equal Weight'}
                      </h4>
                      <p className="text-sm text-gray-600 mt-1">
                        {strategy === 'probability-weighted' ? 'Allocate more to likely scenarios' :
                         strategy === 'max-protection' ? 'Focus on most likely outcome' : 'Spread evenly (simpler)'}
                      </p>
                    </button>
                  ))}
                </div>
              </div>

              <button onClick={calculateHedge} disabled={calculating}
                className="mt-8 w-full md:w-auto px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50">
                {calculating ? 'Calculating...' : 'Calculate Hedge Strategy'}
              </button>
            </div>

            {/* Results Section */}
            {showResults && hedgeData && (
              <div className="mt-8 space-y-8 fade-in">
                {/* Risk/Opportunity Alerts */}
                <div className="space-y-4">
                  <div className="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg">
                    <h3 className="text-lg font-semibold text-red-900">
                      Annual Opportunity Cost: <span className="highlight">{fmt(yearlyOpportunityCost)}</span>
                    </h3>
                    <p className="mt-2 text-red-700">
                      You need {cutsToRefinance} rate cuts to reach your {refinanceThreshold}% refinance threshold
                    </p>
                  </div>

                  <div className="bg-green-50 border-l-4 border-green-500 p-6 rounded-lg">
                    <h3 className="text-lg font-semibold text-green-900">
                      Optimal Hedge: <span className="highlight">{fmt(optimalHedgeAmount)}</span>
                    </h3>
                    <p className="mt-2 text-green-700">
                      Using Kalshi KXRATECUTCOUNT markets to protect against rates staying high
                    </p>
                  </div>
                </div>

                {/* Fed Markets */}
                <div className="bg-white rounded-xl shadow-lg p-8">
                  <h2 className="text-xl font-semibold mb-4">Fed Rate Cut Markets</h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {fedMarkets.map(market => (
                      <a key={market.ticker} href={`https://kalshi.com/markets/${market.ticker}`}
                        target="_blank" rel="noopener noreferrer"
                        className="p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                        <div className="flex justify-between items-start">
                          <div>
                            <h4 className="font-semibold">{market.cuts} {market.cuts === 1 ? 'cut' : 'cuts'}</h4>
                            <p className="text-xs text-gray-500 mt-1">{market.ticker}</p>
                          </div>
                          <div className="text-right">
                            <p className="text-lg font-bold">{market.price}¢</p>
                            <p className="text-xs text-gray-500">{market.yes_bid}-{market.yes_ask} spread</p>
                          </div>
                        </div>
                        <div className="mt-2 text-xs text-blue-600">View on Kalshi →</div>
                      </a>
                    ))}
                  </div>
                </div>

                {/* Hedge Allocation */}
                <div className="bg-white rounded-xl shadow-lg p-8">
                  <h2 className="text-2xl font-semibold mb-6">Your Hedge Allocation</h2>
                  <div className="space-y-4">
                    {hedgeData.allocations.map((alloc, idx) => (
                      <div key={idx} className="border border-gray-200 rounded-lg p-4">
                        <div className="flex justify-between items-start mb-3">
                          <div>
                            <h4 className="font-semibold text-lg">
                              {alloc.cuts === 0 ? 'No cuts' : `${alloc.cuts} cut${alloc.cuts > 1 ? 's' : ''}`}
                            </h4>
                            <p className="text-sm text-gray-500">
                              {(alloc.probability * 100).toFixed(0)}% chance | Price: {alloc.price}¢
                            </p>
                            <a href={alloc.kalshiUrl} target="_blank" rel="noopener noreferrer"
                              className="text-xs text-blue-600 hover:underline">Trade on Kalshi →</a>
                          </div>
                          <div className="text-right">
                            <p className="text-sm text-gray-500">Investment</p>
                            <p className="font-semibold text-lg">{fmt(alloc.allocation)}</p>
                            <p className="text-xs text-gray-500">{alloc.contracts} contracts</p>
                          </div>
                        </div>
                        
                        <div className="bg-gray-50 rounded p-3">
                          <div className="grid grid-cols-4 gap-4 text-sm">
                            <div><span className="text-gray-500">Cost:</span> {fmt(alloc.cost)}</div>
                            <div><span className="text-gray-500">Fees:</span> {fmt(alloc.fees)}</div>
                            <div><span className="text-gray-500">If wins:</span> {fmt(alloc.payout)}</div>
                            <div><span className="text-gray-500">Net profit:</span> <span className="text-green-600">+{fmt(alloc.netProfit)}</span></div>
                          </div>
                        </div>
                      </div>
                    ))}
                    
                    <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                      <div className="flex justify-between font-semibold">
                        <span>Total Hedge Investment:</span>
                        <span>{fmt(hedgeData.total_hedge_cost)}</span>
                      </div>
                      <div className="flex justify-between font-semibold mt-2">
                        <span>Expected Value:</span>
                        <span className="text-green-600">+{fmt(hedgeData.expected_value)}</span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Probability-Weighted Outcomes */}
                {scenarios && (
                  <div className="bg-white rounded-xl shadow-lg p-8">
                    <h2 className="text-2xl font-semibold mb-6">Probability-Weighted Outcomes</h2>
                    
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead>
                          <tr className="text-left text-sm font-medium text-gray-700 border-b">
                            <th className="pb-3">Rate Cuts</th>
                            <th className="pb-3">Probability</th>
                            <th className="pb-3">New Rate</th>
                            <th className="pb-3">Hedge Result</th>
                            <th className="pb-3">Refi Savings</th>
                            <th className="pb-3">Net Outcome</th>
                          </tr>
                        </thead>
                        <tbody>
                          {scenarios.outcomes.map((outcome, idx) => (
                            <tr key={idx} className={`border-b ${outcome.isRefi ? 'bg-purple-50' : 'bg-blue-50'}`}>
                              <td className="py-3">{outcome.cuts} {outcome.cuts === 1 ? 'cut' : 'cuts'}</td>
                              <td className="py-3">{(outcome.probability * 100).toFixed(0)}%</td>
                              <td className="py-3">{outcome.rateAfterCuts.toFixed(2)}%</td>
                              <td className="py-3">
                                <span className={outcome.hedgeResult >= 0 ? 'text-green-600 font-semibold' : 'text-red-600'}>
                                  {outcome.hedgeResult >= 0 ? '+' : ''}{fmt(outcome.hedgeResult)}
                                </span>
                              </td>
                              <td className="py-3">
                                {outcome.refiSavings > 0 ? (
                                  <span className="text-green-600 font-semibold">+{fmt(outcome.refiSavings)}</span>
                                ) : (
                                  <span className="text-gray-400">—</span>
                                )}
                              </td>
                              <td className="py-3 font-bold">
                                <span className={outcome.netOutcome >= 0 ? 'text-green-600' : 'text-red-600'}>
                                  {outcome.netOutcome >= 0 ? '+' : ''}{fmt(outcome.netOutcome)}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>

                    <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                      <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                        <h3 className="text-sm font-medium opacity-90">No-Refi Expected Value</h3>
                        <p className="text-2xl font-bold mt-2">{scenarios.noRefiExpected >= 0 ? '+' : ''}{fmt(scenarios.noRefiExpected)}</p>
                      </div>
                      
                      <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-6 text-white">
                        <h3 className="text-sm font-medium opacity-90">Refi Expected Value</h3>
                        <p className="text-2xl font-bold mt-2">{scenarios.refiExpected >= 0 ? '+' : ''}{fmt(scenarios.refiExpected)}</p>
                      </div>
                      
                      <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white">
                        <h3 className="text-sm font-medium opacity-90">Total Expected Value</h3>
                        <p className="text-2xl font-bold mt-2">{scenarios.totalExpected >= 0 ? '+' : ''}{fmt(scenarios.totalExpected)}</p>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>

          <footer className="mt-16 bg-gray-800 text-white py-8">
            <div className="max-w-7xl mx-auto px-4 text-center">
              <p className="text-gray-400">Live market data from Kalshi. Not financial advice.</p>
              <p className="mt-2 text-sm text-gray-500">Markets update every 30 seconds. Fees: 7¢ per contract.</p>
            </div>
          </footer>
        </div>
      );
    }

    ReactDOM.render(<MortgageHedgeCalculator />, document.getElementById('root'));
  </script>
</body>
</html>